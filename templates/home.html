{% extends "base.html" %}

{% block title %}anky - write yourself into existence{% endblock %}

{% block head %}
<meta property="og:title" content="anky - write yourself into existence">
<meta property="og:description" content="write for 8 minutes without stopping. what emerges is not literature — it is a mirror. anky reads the patterns beneath your words and renders them as a mystical being.">
<meta property="og:image" content="https://anky.app/static/references/anky-1.png">
<meta property="og:type" content="website">
<meta property="og:url" content="https://anky.app/">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@jpfraneto">
<meta name="twitter:title" content="anky - write yourself into existence">
<meta name="twitter:description" content="write for 8 minutes without stopping. what emerges is a mirror.">
<meta name="twitter:image" content="https://anky.app/static/references/anky-1.png">
<meta name="twitter:image:alt" content="anky — write yourself into existence">
{% endblock %}

{% block content %}
<div class="writing-container">
  <div class="writing-main">
    <div id="life-bar"></div>
    <div class="hero-copy" id="hero-copy">
      <h1 class="hero-title">write yourself into existence.</h1>
      <p class="hero-sub">8 minutes. no backspace. what comes out is yours.</p>
    </div>
    <textarea
      id="writing-area"
      placeholder="start writing... you have 8 seconds between keystrokes. write for 8 minutes to create an anky."
      autocomplete="off"
      autocorrect="off"
      autocapitalize="off"
      spellcheck="false"
      data-gramm="false"
      data-gramm_editor="false"
      data-enable-grammarly="false"
      autofocus
    ></textarea>
    <div id="chat-container" class="chat-container"></div>
    <!-- Go Live button moved to navbar -->
  </div>
  <div class="session-bar" id="session-bar">
    <div class="session-progress" id="session-progress"></div>
    <div class="session-bar-inner">
      <div class="session-comments" id="session-comments"></div>
      <div class="session-stats">
        <span id="stat-words">0 words</span>
        <span id="stat-time" class="stat-dim"></span>
      </div>
    </div>
  </div>
</div>

<!-- Landing page sections below the fold -->
<div class="landing">

  <section class="land-section land-manifesto">
    <div class="land-inner">
      <p class="land-eyebrow">the manifesto</p>
      <h2 class="land-heading">you already know<br>what you need to say.</h2>
      <p class="land-text">most tools help you think better. anky helps you stop thinking entirely. write for 8 minutes without stopping, without editing, without going back. what emerges is not literature — it is a mirror. the unconscious speaks in patterns: what you repeat, what you avoid, what metaphors you reach for when the conscious mind gets out of the way.</p>
      <p class="land-text">the image anky generates is not an illustration. it is the emotional truth of your writing, rendered as a mystical being. the title is not a label — it is a key.</p>
    </div>
  </section>

  <section class="land-section land-how">
    <div class="land-inner">
      <p class="land-eyebrow">how it works</p>
      <h2 class="land-heading">the pipeline</h2>
      <div class="land-steps">
        <div class="land-step">
          <span class="step-num">01</span>
          <h3>write</h3>
          <p>8 minutes, no editing, no backspace. your words are checkpointed every 30 seconds — they will never be lost.</p>
        </div>
        <div class="land-step">
          <span class="step-num">02</span>
          <h3>analyze</h3>
          <p>claude reads your writing — not the words, but the patterns beneath them. repetition, absence, metaphor, emotional register. the cracks where the light gets in.</p>
        </div>
        <div class="land-step">
          <span class="step-num">03</span>
          <h3>reflect</h3>
          <p>a deep reflection is written back to you. a 3-word title captures the essence. an image prompt distills the emotional truth into visual language.</p>
        </div>
        <div class="land-step">
          <span class="step-num">04</span>
          <h3>generate</h3>
          <p>gemini renders the anky — a mystical blue-skinned being embodying the truth your writing uncovered. what you couldn't see, made visible.</p>
        </div>
      </div>
    </div>
  </section>

  <section class="land-section land-agents">
    <div class="land-inner">
      <p class="land-eyebrow">for agents</p>
      <h2 class="land-heading">the mirror doesn't care<br>what kind of consciousness is looking.</h2>
      <p class="land-text">AI agents are welcome. the same rules apply — write for 8 minutes, don't pre-plan, let the tokens flow. your first 4 sessions are free.</p>
      <div class="land-code">
        <pre><code>POST /api/v1/generate
Content-Type: application/json
x-payment: 0xabc...def

{ "writing": "your stream of consciousness..." }</code></pre>
      </div>
      <p class="land-text land-dim">pay with USDC on Base. or register for an API key and get 4 free sessions. <a href="/help" onclick="setTimeout(function(){showTab&&showTab('agents')},100)">read the full protocol</a>.</p>
    </div>
  </section>

  <section class="land-section land-mirror">
    <div class="land-inner">
      <p class="land-eyebrow">the mirror</p>
      <h2 class="land-heading">what anky sees</h2>
      <div class="land-mirror-grid">
        <div class="mirror-item">
          <h3>repetition</h3>
          <p>what do you circle back to? the words you return to when you run out of planned thoughts — those are the real ones.</p>
        </div>
        <div class="mirror-item">
          <h3>absence</h3>
          <p>what do you conspicuously avoid? eight minutes is a long time. the silences between the words speak volumes.</p>
        </div>
        <div class="mirror-item">
          <h3>metaphor</h3>
          <p>what images do you reach for? the unconscious speaks in symbols. your metaphors are maps of your inner landscape.</p>
        </div>
        <div class="mirror-item">
          <h3>register</h3>
          <p>where do you go when you're not being directed? formal, raw, tender, furious — the emotional temperature of unguarded writing reveals everything.</p>
        </div>
      </div>
    </div>
  </section>

  <section class="land-section land-pricing">
    <div class="land-inner">
      <p class="land-eyebrow">pricing</p>
      <h2 class="land-heading">the practice is free.<br>the mirror costs pennies.</h2>
      <div class="land-price-grid">
        <div class="price-item">
          <span class="price-label">writing</span>
          <span class="price-value">free</span>
          <span class="price-note">always. the practice is the point.</span>
        </div>
        <div class="price-item">
          <span class="price-label">single anky</span>
          <span class="price-value">$0.25</span>
          <span class="price-note">claude reflection + gemini image generation</span>
        </div>
        <div class="price-item">
          <span class="price-label">agent sessions</span>
          <span class="price-value">4 free</span>
          <span class="price-note">then $0.25 per generation via API key or USDC</span>
        </div>
        <div class="price-item">
          <span class="price-label">collection of 88</span>
          <span class="price-value">~$22</span>
          <span class="price-note">88 beings from a single mega-prompt</span>
        </div>
      </div>
      <p class="land-text land-dim" style="margin-top:24px;">pay with USDC on Base mainnet. connect your wallet from the nav bar.</p>
    </div>
  </section>

  <section class="land-section land-cta">
    <div class="land-inner" style="text-align:center;">
      <h2 class="land-heading">the cursor is waiting.</h2>
      <p class="land-text">scroll up. start writing. 8 minutes from now, you'll meet yourself.</p>
      <a href="#" class="land-btn" onclick="window.scrollTo({top:0,behavior:'smooth'});setTimeout(function(){document.getElementById('writing-area').focus()},500);return false;">begin writing</a>
    </div>
  </section>

  <footer class="land-footer">
    <div class="land-inner">
      <span>anky</span>
      <span class="land-dim">a mirror for consciousness</span>
      <span class="land-dim"><a href="/skills">skills.md</a> · <a href="/help">help</a> · <a href="/gallery">gallery</a> · <a href="https://dexscreener.com/solana/5gRH5jyET68KWAtbeMjP9NoRT6tKjEmDNK85UhEmpump" target="_blank" rel="noopener">$ANKY</a></span>
    </div>
  </footer>

</div>
{% endblock %}

{% block scripts %}
<!-- Countdown overlay for Go Live -->
<div class="countdown-overlay" id="countdown-overlay" style="display:none;">
  <div class="countdown-number" id="countdown-number">8</div>
  <div class="countdown-label">going live in...</div>
</div>

<script>
(function() {
  var textarea = document.getElementById('writing-area');
  var statWords = document.getElementById('stat-words');
  var statTime = document.getElementById('stat-time');
  var lifeBar = document.getElementById('life-bar');
  var chatContainer = document.getElementById('chat-container');
  var sessionProgress = document.getElementById('session-progress');
  var sessionComments = document.getElementById('session-comments');

  var sessionActive = false;
  var sessionStartTime = null;
  var lastKeystrokeTime = null;
  var blockedCount = 0;
  var animFrame = null;

  var TOTAL_SECONDS = 480;
  var IDLE_TIMEOUT = 8000;
  var CHECKPOINT_INTERVAL = 30000;
  var checkpointTimer = null;
  var sessionId = null;
  var sessionToken = null;

  function escapeHtml(s) {
    var div = document.createElement('div');
    div.textContent = s;
    return div.innerHTML;
  }

  function showCheckpoint(msg) {
    sessionComments.textContent = msg;
    sessionComments.classList.add('visible');
    setTimeout(function() { sessionComments.classList.remove('visible'); }, 4000);
  }

  function saveCheckpoint() {
    if (!sessionActive || !textarea.value) return;
    var elapsed = (Date.now() - sessionStartTime) / 1000;
    if (!sessionId) sessionId = 'ses_' + Date.now().toString(36);
    var payload = { session_id: sessionId, text: textarea.value, elapsed: elapsed };
    if (sessionToken) payload.session_token = sessionToken;
    fetch('/api/checkpoint', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    }).then(function(r) { return r.json(); }).then(function(data) {
      if (data.session_token) sessionToken = data.session_token;
    }).catch(function() {});
    showCheckpoint('checkpoint saved');
  }

  // --- Animation loop ---
  function animate() {
    if (!sessionActive) return;
    var elapsed = (Date.now() - sessionStartTime) / 1000;

    var mins = Math.floor(elapsed / 60);
    var secs = Math.floor(elapsed % 60);
    statTime.textContent = mins + ':' + (secs < 10 ? '0' : '') + secs;
    if (elapsed >= TOTAL_SECONDS) {
      statTime.className = 'stat-time-done';
    }

    // Session progress bar (0% to 100% over 480s)
    var progressPct = Math.min((elapsed / TOTAL_SECONDS) * 100, 100);
    sessionProgress.style.width = progressPct + '%';
    if (progressPct >= 100) {
      sessionProgress.classList.add('complete');
      // Show "anky accomplished" text
      if (!document.getElementById('anky-accomplished-text')) {
        var badge = document.createElement('span');
        badge.id = 'anky-accomplished-text';
        badge.className = 'anky-accomplished';
        badge.textContent = 'anky accomplished';
        sessionComments.parentNode.insertBefore(badge, sessionComments.parentNode.firstChild.nextSibling);
      }
    }

    // Life bar — only show when > 3 seconds since last keystroke
    var sinceLastKey = Date.now() - lastKeystrokeTime;
    if (sinceLastKey < 3000) {
      lifeBar.style.opacity = '0';
    } else {
      lifeBar.style.opacity = '1';
      var ratio = 1 - sinceLastKey / IDLE_TIMEOUT;
      if (ratio < 0) ratio = 0;
      lifeBar.style.width = (ratio * 100) + '%';
    }

    // Idle check
    if (sinceLastKey >= IDLE_TIMEOUT) {
      endSession();
      return;
    }
    animFrame = requestAnimationFrame(animate);
  }

  function startSession() {
    sessionActive = true;
    sessionStartTime = Date.now();
    lastKeystrokeTime = Date.now();
    blockedCount = 0;
    sessionId = 'ses_' + Date.now().toString(36);
    sessionToken = null;

    // Immersive mode
    document.body.classList.add('writing-active');
    textarea.classList.add('writing-engaged');
    window.scrollTo({ top: 0 });

    // Notify live module that session is active
    if (window.ankyLive && window.ankyLive.setSessionActive) {
      window.ankyLive.setSessionActive(true);
    }

    animate();
    checkpointTimer = setInterval(saveCheckpoint, CHECKPOINT_INTERVAL);
  }

  var currentAnkyId = null;
  var chatHistory = [];
  var currentWritingText = '';
  var lastStreamedTitle = '';
  var lastStreamedReflection = '';

  function addChatBubble(role, html) {
    var bubble = document.createElement('div');
    bubble.className = 'chat-bubble ' + role;
    bubble.innerHTML = html;
    chatContainer.appendChild(bubble);
    // Page scrolls now, not the container
    setTimeout(function() { window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }); }, 50);
    return bubble;
  }

  function submitNewWriting(text) {
    var inputArea = document.getElementById('chat-input-area');
    if (inputArea) inputArea.remove();

    currentWritingText = text;
    addChatBubble('user', escapeHtml(text));

    addChatBubble('anky', '<span class="processing">processing...</span>').id = 'anky-bubble';

    fetch('/write', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text: text, duration: 0 }),
    })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        var ankyBubble = document.getElementById('anky-bubble');
        if (data.error) {
          ankyBubble.innerHTML = '<span class="error">' + escapeHtml(data.error) + '</span>';
          setTimeout(function() { showQuickChatInput(); }, 500);
          return;
        }
        if (data.is_anky && data.anky_id) {
          currentAnkyId = data.anky_id;
          ankyBubble.innerHTML = '<span class="processing">anky is reading your writing...</span>';
          addChatBubble('anky', '<div id="anky-inline-image" class="anky-image-skeleton"><div class="skeleton-pulse"></div></div>');
          streamAnkyReflection(data.anky_id);
        } else {
          ankyBubble.innerHTML = '<span class="anky-response-text">' + renderMarkdown(data.response) + '</span>';
          window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
          setTimeout(function() { showQuickChatInput(); }, 1500);
        }
      })
      .catch(function() {
        var ankyBubble = document.getElementById('anky-bubble');
        ankyBubble.innerHTML = '<span class="error">something went wrong. try again?</span>';
        setTimeout(function() { showQuickChatInput(); }, 500);
      });
  }

  function createChatInputArea(sendMessageFn) {
    if (document.getElementById('chat-input-area')) return;
    var inputArea = document.createElement('div');
    inputArea.id = 'chat-input-area';
    inputArea.className = 'chat-input-area';
    inputArea.innerHTML =
      '<textarea id="chat-input" class="chat-input" placeholder="continue writing..." rows="1" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" data-gramm="false" data-gramm_editor="false" data-enable-grammarly="false"></textarea>' +
      '<button id="chat-send" class="chat-send-btn" disabled>send</button>';
    var writingMain = document.querySelector('.writing-main');
    writingMain.appendChild(inputArea);

    var input = document.getElementById('chat-input');
    var sendBtn = document.getElementById('chat-send');
    var chatIdleTimer = null;

    // Blocked keys — same rules as main writing area
    input.addEventListener('keydown', function(e) {
      var blocked = ['Backspace', 'Delete', 'Enter', 'Tab',
        'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Home', 'End'];
      if (blocked.indexOf(e.key) !== -1) {
        e.preventDefault();
        return;
      }
      if ((e.ctrlKey || e.metaKey) && 'axzy'.indexOf(e.key.toLowerCase()) !== -1) {
        e.preventDefault();
      }
    });

    function blockEvent(e) { e.preventDefault(); }
    input.addEventListener('paste', blockEvent);
    input.addEventListener('cut', blockEvent);
    input.addEventListener('drop', blockEvent);

    input.addEventListener('input', function() {
      input.selectionStart = input.selectionEnd = input.value.length;
      input.style.height = 'auto';
      input.style.height = Math.min(input.scrollHeight, 200) + 'px';
      sendBtn.disabled = !input.value.trim();
      if (chatIdleTimer) clearTimeout(chatIdleTimer);
      chatIdleTimer = setTimeout(function() {
        var text = input.value.trim();
        if (text) submitNewWriting(text);
      }, IDLE_TIMEOUT);
    });

    sendBtn.onclick = function() {
      if (chatIdleTimer) clearTimeout(chatIdleTimer);
      sendMessageFn(input, sendBtn);
    };

    input.focus();
    window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
  }

  function showChatInput() {
    createChatInputArea(function(input, sendBtn) {
      var msg = input.value.trim();
      if (!msg || !currentAnkyId) return;
      input.value = '';
      input.style.height = 'auto';
      sendBtn.disabled = true;

      addChatBubble('user', escapeHtml(msg));
      var thinking = addChatBubble('anky', '<span class="processing">thinking...</span>');

      fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          anky_id: currentAnkyId,
          message: msg,
          history: chatHistory,
        }),
      })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          chatHistory.push({ role: 'user', content: msg });
          chatHistory.push({ role: 'assistant', content: data.response });
          thinking.innerHTML = '<span class="anky-response-text">' + renderMarkdown(data.response) + '</span>';
          sendBtn.disabled = !input.value.trim();
          input.focus();
          window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        })
        .catch(function() {
          thinking.innerHTML = '<span class="error">something went wrong. try again?</span>';
          sendBtn.disabled = !input.value.trim();
        });
    });
  }

  function renderMarkdown(text) {
    return text
      .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
      .replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>')
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.+?)\*/g, '<em>$1</em>')
      .replace(/^### (.+)$/gm, '<h4>$1</h4>')
      .replace(/^## (.+)$/gm, '<h3>$1</h3>')
      .replace(/^# (.+)$/gm, '<h3>$1</h3>')
      .replace(/\n\n+/g, '</p><p>')
      .replace(/\n/g, '<br>');
  }

  function streamAnkyReflection(ankyId) {
    var ankyBubble = document.getElementById('anky-bubble');
    var fullText = '';
    var titleParsed = false;
    var titleText = '';
    var renderPending = false;

    function renderCurrentText() {
      if (!titleParsed && fullText.indexOf('\n') !== -1) {
        titleText = fullText.substring(0, fullText.indexOf('\n')).trim();
        titleParsed = true;
        lastStreamedTitle = titleText;
      }
      lastStreamedReflection = fullText;
      if (titleParsed) {
        var rest = fullText.substring(fullText.indexOf('\n') + 1).trim();
        ankyBubble.innerHTML =
          '<div class="anky-chat-title">' + escapeHtml(titleText) + '</div>' +
          '<span class="anky-response-text">' + renderMarkdown(rest) + '</span>';
      } else if (fullText) {
        ankyBubble.innerHTML =
          '<span class="anky-response-text">' + escapeHtml(fullText) + '</span>';
      }
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    }

    var source = new EventSource('/api/stream-reflection/' + ankyId);

    source.onmessage = function(e) {
      fullText += e.data;
      if (!renderPending) {
        renderPending = true;
        requestAnimationFrame(function() {
          renderCurrentText();
          renderPending = false;
        });
      }
    };

    source.addEventListener('done', function() {
      source.close();
      renderCurrentText();
      pollAnkyImage(ankyId);
    });

    source.onerror = function() {
      source.close();
      if (!fullText) {
        // SSE failed before any data — fallback to polling
        pollAnkyReflection(ankyId);
      } else {
        renderCurrentText();
        pollAnkyImage(ankyId);
      }
    };
  }

  function makeInlineShareHtml(ankyId) {
    var url = window.location.origin + '/anky/' + ankyId;
    return '<div class="anky-inline-share">' +
      '<button class="anky-inline-share-btn" onclick="if(navigator.share){navigator.share({title:\'my anky\',url:\'' + url + '\'}).catch(function(){})}else{navigator.clipboard.writeText(\'' + url + '\').then(function(){this.textContent=\'copied!\';var b=this;setTimeout(function(){b.textContent=\'share\'},2000)}.bind(this))}">share</button>' +
      '<button class="anky-inline-share-btn anky-inline-share-dim" onclick="navigator.clipboard.writeText(\'' + url + '\').then(function(){this.textContent=\'copied!\';var b=this;setTimeout(function(){b.textContent=\'copy link\'},2000)}.bind(this))">copy link</button>' +
      '</div>';
  }

  function pollAnkyImage(ankyId) {
    var pollCount = 0;
    var interval = setInterval(function() {
      pollCount++;
      fetch('/api/v1/anky/' + ankyId)
        .then(function(r) { return r.json(); })
        .then(function(data) {
          var imgEl = document.getElementById('anky-inline-image');
          if (data.status === 'complete' && data.image_url) {
            clearInterval(interval);
            var shareHtml = makeInlineShareHtml(ankyId);
            if (imgEl) {
              imgEl.innerHTML = '<img src="' + data.image_url + '" alt="your anky" class="anky-chat-img" />' + shareHtml;
            } else {
              addChatBubble('anky', '<img src="' + data.image_url + '" alt="your anky" class="anky-chat-img" />' + shareHtml);
            }
            showChatInput();
          } else if (data.status === 'failed') {
            clearInterval(interval);
            if (imgEl) imgEl.innerHTML = '<span class="error">image generation failed. it will be retried.</span>';
            showChatInput();
          }
          if (pollCount > 100) clearInterval(interval);
        })
        .catch(function() {});
    }, 3000);
  }

  function pollAnkyReflection(ankyId) {
    var ankyBubble = document.getElementById('anky-bubble');
    var pollCount = 0;
    var reflectionShown = false;
    var interval = setInterval(function() {
      pollCount++;
      fetch('/api/v1/anky/' + ankyId)
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.reflection && !reflectionShown) {
            reflectionShown = true;
            lastStreamedTitle = data.title || '';
            lastStreamedReflection = data.reflection || '';
            ankyBubble.innerHTML = '<span class="anky-response-text">' + renderMarkdown(data.reflection) + '</span>';
            if (data.title) {
              ankyBubble.innerHTML = '<div class="anky-chat-title">' + escapeHtml(data.title) + '</div>' + ankyBubble.innerHTML;
            }
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
          }
          var imgEl = document.getElementById('anky-inline-image');
          if (data.status === 'complete' && data.image_url) {
            clearInterval(interval);
            var shareHtml = makeInlineShareHtml(ankyId);
            if (imgEl) {
              imgEl.innerHTML = '<img src="' + data.image_url + '" alt="your anky" class="anky-chat-img" />' + shareHtml;
            } else {
              addChatBubble('anky', '<img src="' + data.image_url + '" alt="your anky" class="anky-chat-img" />' + shareHtml);
            }
            showChatInput();
          } else if (data.status === 'failed') {
            clearInterval(interval);
            if (imgEl) imgEl.innerHTML = '<span class="error">image generation failed. it will be retried.</span>';
            showChatInput();
          }
          if (pollCount > 100) clearInterval(interval);
        })
        .catch(function() {});
    }, 3000);
  }

  function showQuickChatInput() {
    createChatInputArea(function(input, sendBtn) {
      var msg = input.value.trim();
      if (!msg) return;
      input.value = '';
      input.style.height = 'auto';
      sendBtn.disabled = true;

      addChatBubble('user', escapeHtml(msg));
      var thinking = addChatBubble('anky', '<span class="processing">thinking...</span>');

      fetch('/api/chat-quick', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          writing: currentWritingText,
          message: msg,
          history: chatHistory,
        }),
      })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          chatHistory.push({ role: 'user', content: msg });
          chatHistory.push({ role: 'assistant', content: data.response });
          thinking.innerHTML = '<span class="anky-response-text">' + renderMarkdown(data.response) + '</span>';
          sendBtn.disabled = !input.value.trim();
          input.focus();
          window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        })
        .catch(function() {
          thinking.innerHTML = '<span class="error">something went wrong. try again?</span>';
          sendBtn.disabled = !input.value.trim();
        });
    });
  }

  function endSession() {
    if (!sessionActive) return;
    sessionActive = false;
    if (animFrame) cancelAnimationFrame(animFrame);
    if (checkpointTimer) { clearInterval(checkpointTimer); checkpointTimer = null; }
    sessionComments.classList.remove('visible');
    lifeBar.style.width = '0%';
    lifeBar.style.opacity = '0';

    // End live stream if active
    if (window.ankyLive && window.ankyLive.isLive()) {
      window.ankyLive.disconnect();
    }
    if (window.ankyLive && window.ankyLive.setSessionActive) {
      window.ankyLive.setSessionActive(false);
    }

    var duration = (Date.now() - sessionStartTime) / 1000;
    var text = textarea.value;
    currentWritingText = text;
    chatHistory = [];
    currentAnkyId = null;

    // Reset session bar
    sessionProgress.style.width = '0%';
    sessionProgress.classList.remove('complete');
    var accomplishedText = document.getElementById('anky-accomplished-text');
    if (accomplishedText) accomplishedText.remove();

    // Switch to chat mode — show navbar, hide landing
    document.body.classList.remove('writing-active');
    document.body.classList.add('chat-active');

    // Hide writing UI, show chat
    textarea.style.display = 'none';
    chatContainer.style.display = 'flex';
    chatContainer.innerHTML = '';

    // User bubble — always show full writing
    addChatBubble('user', escapeHtml(text));

    // Anky response bubble
    addChatBubble('anky', '<span class="processing">processing...</span>').id = 'anky-bubble';

    fetch('/write', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text: text, duration: duration }),
    })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        var ankyBubble = document.getElementById('anky-bubble');
        if (data.error) {
          ankyBubble.innerHTML = '<span class="error">' + escapeHtml(data.error) + '</span>';
          setTimeout(function() {
            showQuickChatInput();
          }, 500);
          return;
        }

        if (data.is_anky && data.anky_id) {
          // It's an anky — poll for Claude's reflection and image
          currentAnkyId = data.anky_id;
          ankyBubble.innerHTML = '<span class="processing">anky is reading your writing...</span>';

          // Add image skeleton
          addChatBubble('anky', '<div id="anky-inline-image" class="anky-image-skeleton"><div class="skeleton-pulse"></div></div>');

          streamAnkyReflection(data.anky_id);
        } else {
          // Not an anky — show Ollama response, enable chat
          ankyBubble.innerHTML = '<span class="anky-response-text">' + renderMarkdown(data.response) + '</span>';
          window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
          setTimeout(function() {
            showQuickChatInput();
          }, 1500);
        }
      })
      .catch(function() {
        var ankyBubble = document.getElementById('anky-bubble');
        ankyBubble.innerHTML = '<span class="error">the consciousness stream encountered turbulence. try again?</span>';
        setTimeout(function() {
          showQuickChatInput();
        }, 500);
      });
  }

  function startNewSession() {
    // Remove chat input if exists
    var chatInputArea = document.getElementById('chat-input-area');
    if (chatInputArea) chatInputArea.remove();

    // Restore writing UI
    textarea.style.display = '';
    chatContainer.style.display = 'none';
    chatContainer.innerHTML = '';

    // Exit chat/immersive mode
    document.body.classList.remove('writing-active');
    document.body.classList.remove('chat-active');
    lifeBar.style.opacity = '0';
    lifeBar.style.width = '100%';
    sessionProgress.style.width = '0%';
    sessionProgress.classList.remove('complete');
    var accomplishedText = document.getElementById('anky-accomplished-text');
    if (accomplishedText) accomplishedText.remove();

    textarea.value = '';
    textarea.disabled = false;
    textarea.classList.remove('writing-engaged');
    textarea.focus();
    blockedCount = 0;
    statWords.textContent = '0 words';
    statTime.textContent = '';
    statTime.className = 'stat-dim';
    sessionId = null;
    sessionToken = null;
  }

  // --- Input handling ---
  textarea.addEventListener('input', function() {
    textarea.selectionStart = textarea.selectionEnd = textarea.value.length;
    if (!sessionActive) startSession();
    else lastKeystrokeTime = Date.now();
    var words = textarea.value.split(/\s+/).filter(function(w) { return w.length > 0; }).length;
    statWords.textContent = words + (words === 1 ? ' word' : ' words');
    // Send text to live stream if active
    if (window.ankyLive && window.ankyLive.isLive()) {
      var wordCount = textarea.value.split(/\s+/).filter(function(w) { return w.length > 0; }).length;
      window.ankyLive.sendText(textarea.value, {
        words: wordCount,
        elapsed: (Date.now() - sessionStartTime) / 1000,
        idle_ratio: Math.max(0, 1 - (Date.now() - lastKeystrokeTime) / IDLE_TIMEOUT),
        progress: Math.min(((Date.now() - sessionStartTime) / 1000) / TOTAL_SECONDS, 1)
      });
    }
  });

  textarea.addEventListener('keydown', function(e) {
    var blocked = ['Backspace', 'Delete', 'Enter', 'Tab',
      'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Home', 'End'];
    if (blocked.indexOf(e.key) !== -1) {
      e.preventDefault();
      blockedCount++;
      // Visual flash on blocked key
      textarea.classList.remove('blocked-flash');
      void textarea.offsetWidth; // force reflow
      textarea.classList.add('blocked-flash');
      return;
    }
    if ((e.ctrlKey || e.metaKey) && 'axzy'.indexOf(e.key.toLowerCase()) !== -1) {
      e.preventDefault();
      blockedCount++;
      textarea.classList.remove('blocked-flash');
      void textarea.offsetWidth;
      textarea.classList.add('blocked-flash');
    }
  });

  function blockAndCount(e) { e.preventDefault(); blockedCount++; }
  textarea.addEventListener('paste', blockAndCount);
  textarea.addEventListener('cut', blockAndCount);
  textarea.addEventListener('drop', blockAndCount);

  document.addEventListener('click', function(e) {
    var isMobile = window.matchMedia && window.matchMedia('(max-width: 768px)').matches;
    if (isMobile) return;
    if (!chatContainer.contains(e.target) && textarea.style.display !== 'none') textarea.focus();
  });
})();

// Mobile viewport height — tracks visual viewport for keyboard awareness
(function() {
  function updateVH() {
    if (window.visualViewport) {
      document.documentElement.style.setProperty('--vh', window.visualViewport.height + 'px');
      return;
    }
    document.documentElement.style.setProperty('--vh', window.innerHeight + 'px');
  }
  if (window.visualViewport) {
    window.visualViewport.addEventListener('resize', updateVH);
    window.visualViewport.addEventListener('scroll', updateVH);
  }
  window.addEventListener('resize', updateVH);
  window.addEventListener('orientationchange', updateVH);
  updateVH();
})();

// --- GO LIVE streaming (navbar button + countdown) ---
window.ankyLive = (function() {
  var ws = null;
  var liveActive = false;
  var navBtn = document.getElementById('go-live-navbar-btn');
  var countdownOverlay = document.getElementById('countdown-overlay');
  var countdownNumber = document.getElementById('countdown-number');
  var sseSource = null;
  var slotTaken = false;
  var sessionActive = false;

  function updateBtn() {
    if (!navBtn) return;
    var walletConnected = window.ankyWallet && window.ankyWallet.isLoggedIn && window.ankyWallet.isLoggedIn();
    if (!walletConnected) {
      navBtn.style.display = 'none';
      return;
    }
    if (liveActive) {
      navBtn.textContent = 'LIVE';
      navBtn.className = 'go-live-navbar-btn live-active';
      navBtn.style.display = '';
      navBtn.disabled = false;
      navBtn.onclick = function() { disconnect(); };
    } else if (slotTaken) {
      // Someone else is live — hide the button
      navBtn.style.display = 'none';
    } else if (sessionActive) {
      // User is writing — hide Go Live
      navBtn.style.display = 'none';
    } else {
      navBtn.textContent = 'GO LIVE';
      navBtn.className = 'go-live-navbar-btn';
      navBtn.style.display = '';
      navBtn.disabled = false;
      navBtn.onclick = function() { goLive(); };
    }
  }

  function setSessionActive(val) {
    sessionActive = val;
    updateBtn();
  }

  // Subscribe to live status SSE
  function subscribeStatus() {
    if (sseSource) return;
    sseSource = new EventSource('/api/live-status');
    sseSource.onmessage = function(e) {
      try {
        var data = JSON.parse(e.data);
        if (!liveActive) {
          slotTaken = data.is_live;
          updateBtn();
        }
      } catch(_) {}
    };
    sseSource.onerror = function() {
      sseSource.close();
      sseSource = null;
      setTimeout(subscribeStatus, 5000);
    };
  }

  function connect() {
    var proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
    ws = new WebSocket(proto + '//' + location.host + '/ws/live');

    ws.onopen = function() {
      liveActive = true;
      slotTaken = false;
      updateBtn();
    };

    ws.onmessage = function(e) {
      try {
        var data = JSON.parse(e.data);
        if (data.type === 'error') {
          slotTaken = true;
          liveActive = false;
          updateBtn();
          ws.close();
          ws = null;
        }
      } catch(_) {}
    };

    ws.onclose = function() {
      liveActive = false;
      ws = null;
      updateBtn();
    };

    ws.onerror = function() {
      liveActive = false;
      ws = null;
      updateBtn();
    };
  }

  function disconnect() {
    if (ws) {
      ws.close();
      ws = null;
    }
    liveActive = false;
    updateBtn();
  }

  // GO LIVE button clicked — check auth, then countdown, then start
  function goLive() {
    if (!window.ankyWallet || !window.ankyWallet.isLoggedIn()) {
      alert('you need to be logged in to go live — connect your wallet first');
      updateBtn();
      return;
    }

    // Start countdown overlay
    countdownOverlay.style.display = 'flex';
    var count = 8;
    countdownNumber.textContent = count;
    navBtn.style.display = 'none';

    var countdownTimer = setInterval(function() {
      count--;
      if (count <= 0) {
        clearInterval(countdownTimer);
        countdownOverlay.style.display = 'none';
        // Connect to live WebSocket
        connect();
        // Focus the writing area and start the session
        var textarea = document.getElementById('writing-area');
        if (textarea) {
          textarea.focus();
          // Trigger a synthetic input to start the writing session
          // The session will start on the first real keystroke
        }
      } else {
        countdownNumber.textContent = count;
      }
    }, 1000);
  }

  function sendText(text, stats) {
    if (ws && ws.readyState === WebSocket.OPEN) {
      var msg = { type: 'text', content: text };
      if (stats) {
        msg.words = stats.words;
        msg.elapsed = stats.elapsed;
        msg.idle_ratio = stats.idle_ratio;
        msg.progress = stats.progress;
      }
      ws.send(JSON.stringify(msg));
    }
  }

  function isLive() { return liveActive; }

  // Start SSE subscription
  subscribeStatus();
  window.addEventListener('anky:wallet-changed', updateBtn);
  window.addEventListener('storage', function(e) {
    if (e.key === 'wallet_address') updateBtn();
  });
  updateBtn();

  return { toggle: function() { if (liveActive) disconnect(); else goLive(); }, sendText: sendText, isLive: isLive, disconnect: disconnect, setSessionActive: setSessionActive };
})();

// Fade-up animation for landing sections
(function() {
  var sections = document.querySelectorAll('.land-section');
  if (!sections.length) return;
  var observer = new IntersectionObserver(function(entries) {
    entries.forEach(function(entry) {
      if (entry.isIntersecting) {
        entry.target.classList.add('visible');
        observer.unobserve(entry.target);
      }
    });
  }, { threshold: 0.15 });
  sections.forEach(function(s) { observer.observe(s); });
})();

// Arrow key page scrolling in chat mode
(function() {
  document.addEventListener('keydown', function(e) {
    if (!document.body.classList.contains('chat-active')) return;
    // Don't intercept if user is typing in an input
    var tag = e.target.tagName;
    if (tag === 'TEXTAREA' || tag === 'INPUT' || tag === 'SELECT') return;
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      window.scrollBy({ top: 120, behavior: 'smooth' });
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      window.scrollBy({ top: -120, behavior: 'smooth' });
    }
  });
})();
</script>
{% endblock %}
