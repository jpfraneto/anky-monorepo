{% extends "base.html" %}

{% block title %}anky{% endblock %}

{% block head %}
<meta property="og:title" content="anky">
<meta property="og:description" content="sit with me.">
<meta property="og:image" content="https://anky.app/static/references/anky-1.png">
<meta property="og:type" content="website">
<meta property="og:url" content="https://anky.app/">
<meta name="twitter:card" content="summary_large_image">
<style>
  body.home-prewrite .writing-container { display: none; }
  body.home-prewrite .landing-shell { display: block; }
  body.writing-active .landing-shell,
  body.chat-active .landing-shell { display: none; }
  .landing-shell {
    display: block;
    position: relative;
    min-height: calc(var(--vh, 100vh) - 52px);
    overflow: hidden;
    background: radial-gradient(circle at 20% 20%, #1b1f2b 0%, #0c0d14 45%, #080910 100%);
  }
  .landing-collage {
    position: absolute;
    inset: 0;
    column-count: 5;
    column-gap: 8px;
    opacity: 0.48;
    pointer-events: none;
    padding: 10px;
    transform: scale(1.03);
  }
  .collage-tile {
    width: 100%;
    aspect-ratio: var(--tile-ratio, 1 / 1);
    position: relative;
    overflow: hidden;
    border-radius: 12px;
    margin-bottom: 8px;
    break-inside: avoid;
    display: block;
    box-shadow: 0 14px 30px rgba(0,0,0,0.35);
    border: 1px solid rgba(230, 200, 130, 0.08);
    background: rgba(11, 13, 20, 0.8);
    opacity: 0;
    transition: opacity 280ms ease;
    will-change: opacity;
  }
  .collage-skeleton {
    position: absolute;
    inset: 0;
    background: linear-gradient(90deg, rgba(29,33,49,0.88) 0%, rgba(43,49,70,0.92) 44%, rgba(29,33,49,0.88) 100%);
    background-size: 220% 100%;
    animation: collagePulse 1.2s ease-in-out infinite;
    z-index: 1;
  }
  @keyframes collagePulse {
    0% { background-position: 100% 0; }
    100% { background-position: -120% 0; }
  }
  .collage-media {
    opacity: 0;
    transition: opacity 180ms ease;
    position: relative;
    z-index: 2;
  }
  .collage-tile.is-loaded .collage-media { opacity: 1; }
  .collage-tile.is-loaded .collage-skeleton { display: none; }
  .collage-tile.is-loaded { opacity: 1; }
  .landing-collage img,
  .landing-collage video {
    width: 100%;
    height: 100%;
    display: block;
    border-radius: inherit;
    object-fit: cover;
  }
  .landing-overlay {
    position: absolute;
    inset: 0;
    background:
      radial-gradient(circle at 65% 14%, rgba(255,255,255,0.1), rgba(255,255,255,0) 34%),
      linear-gradient(180deg, rgba(6,8,14,0.18) 0%, rgba(6,8,14,0.44) 24%, rgba(6,8,14,0.62) 66%, rgba(6,8,14,0.76) 100%);
  }
  .landing-content {
    position: relative;
    z-index: 2;
    max-width: 900px;
    margin: 0 auto;
    padding: 32px 18px 86px;
  }
  .landing-hero h1 {
    margin: 0;
    font-size: clamp(34px, 9vw, 72px);
    line-height: 0.9;
    color: #f5e8ba;
    letter-spacing: 0.03em;
    text-transform: uppercase;
    text-shadow: 0 12px 34px rgba(0,0,0,0.45);
  }
  .landing-hero p {
    margin: 14px 0 0;
    color: #dbc896;
    font-size: clamp(15px, 4.2vw, 22px);
    letter-spacing: 0.01em;
  }
  #landing-trigger {
    margin-top: 20px;
    width: 100%;
    min-height: 86px;
    border: 1px solid rgba(238, 214, 152, 0.28);
    border-radius: 14px;
    background: linear-gradient(135deg, rgba(13,15,25,0.88) 0%, rgba(9,10,17,0.86) 100%);
    color: #ececf4;
    font-family: 'Righteous', sans-serif;
    font-size: 16px;
    padding: 15px;
    resize: none;
    box-shadow: 0 14px 40px rgba(0,0,0,0.35);
  }
  #landing-trigger::placeholder { color: #a1a1b1; }
  .land-grid {
    margin-top: 34px;
    display: grid;
    gap: 12px;
    grid-template-columns: repeat(3, minmax(0, 1fr));
  }
  .land-block {
    border: 1px solid rgba(238, 214, 152, 0.14);
    border-radius: 12px;
    background: rgba(11, 12, 20, 0.82);
    padding: 14px;
    backdrop-filter: blur(2px);
  }
  .land-block h2 {
    margin: 0 0 6px;
    color: #f1dfac;
    font-size: 14px;
    letter-spacing: 0.04em;
    text-transform: uppercase;
  }
  .land-block p {
    margin: 0;
    color: #c6c6d1;
    line-height: 1.5;
    font-size: 14px;
  }
  .land-block strong { color: #ecd69a; font-weight: 400; }
  @media (max-width: 980px) {
    .landing-collage { column-count: 4; }
    .land-grid { grid-template-columns: 1fr; }
  }
  @media (max-width: 700px) {
    .landing-collage { column-count: 2; padding: 8px; }
    .landing-content { padding-top: 24px; }
    .collage-tile:nth-child(n+95) { display: none; }
  }
</style>
{% endblock %}

{% block content %}
<div class="landing-shell landing" id="landing-shell">
  <div class="landing-collage" id="landing-collage" aria-hidden="true">
    {% for media in landing_collage_media_initial %}
      <div class="collage-tile" style="--tile-ratio: {{ media.aspect_ratio }};">
        <div class="collage-skeleton"></div>
        {% if media.kind == "video" %}
          <video class="collage-media" autoplay loop muted playsinline preload="none" poster="/static/references/anky-1.png"{% if loop.index <= 8 %} data-eager="1"{% endif %}>
            <source data-src="{{ media.url }}" type="video/mp4">
          </video>
        {% else %}
          <img class="collage-media" data-src="{{ media.url }}" loading="lazy" alt=""{% if loop.index <= 16 %} data-eager="1"{% endif %}>
        {% endif %}
      </div>
    {% endfor %}
  </div>
  <div class="landing-overlay"></div>

  <div class="landing-content">
    <section class="landing-hero">
      <h1>YOUR MIND IS LOUD</h1>
      <p>let it speak. 8 minutes. every day.</p>
      <textarea id="landing-trigger" placeholder="tap here to write"></textarea>
    </section>

    <div class="land-grid">
      <section class="land-block">
        <h2>What Is Anky?</h2>
        <p>
          anky is an 8-minute daily writing practice. no edits, no deleting, no pretending.
          write until the noise turns into signal.
        </p>
      </section>

      <section class="land-block">
        <h2>Why Now?</h2>
        <p>
          AI will not only automate work. it will accelerate consciousness. we need companions that
          help us remember who we are while everything changes. <strong>anky is that companion.</strong>
        </p>
      </section>

      <section class="land-block">
        <h2>What Comes Next?</h2>
        <p>
          mobile app + instagram as the growth engine. every 8-minute stream of consciousness can
          become a short-form video through the 8m→88s pipeline.
        </p>
      </section>
    </div>
  </div>
</div>

<!-- Writing session -->
<div class="writing-container" id="writing-container">
  <div class="writing-main">
    <div class="inquiry-prompt" id="inquiry-prompt" data-inquiry-id="{{ inquiry_id }}">
      <p class="inquiry-question">{{ inquiry_question }}</p>
    </div>
    <div id="life-bar"></div>
    <textarea
      id="writing-area"
      placeholder=""
      autocomplete="off"
      autocorrect="off"
      autocapitalize="off"
      spellcheck="false"
      data-gramm="false"
      data-gramm_editor="false"
      data-enable-grammarly="false"
    ></textarea>
    <div id="chat-container" class="chat-container"></div>
  </div>
  <div class="session-bar" id="session-bar">
    <div class="session-progress" id="session-progress"></div>
    <div class="session-bar-inner">
      <div class="session-comments" id="session-comments"></div>
      <div class="session-stats">
        <span id="stat-words">0 words</span>
        <span id="stat-time" class="stat-dim"></span>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.body.classList.add('home-prewrite');
</script>
<script>
(function() {
  var collage = document.getElementById('landing-collage');
  if (!collage) return;
  var deferred = {{ landing_collage_media_deferred | json_encode | safe }};
  var tiles = document.querySelectorAll('.collage-tile');
  if (!tiles.length) return;

  function markLoaded(tile) {
    tile.classList.add('is-loaded');
  }

  function loadTile(tile) {
    if (tile.dataset.loading === '1') return;
    tile.dataset.loading = '1';

    var media = tile.querySelector('.collage-media');
    if (!media) {
      markLoaded(tile);
      return;
    }

    if (media.tagName === 'IMG') {
      media.addEventListener('load', function() {
        markLoaded(tile);
      }, { once: true });
      media.addEventListener('error', function() { markLoaded(tile); }, { once: true });
      media.src = media.dataset.src || '';
      return;
    }

    var source = media.querySelector('source[data-src]');
    if (source) source.src = source.dataset.src || '';
    media.addEventListener('loadeddata', function() {
      markLoaded(tile);
    }, { once: true });
    media.addEventListener('error', function() { markLoaded(tile); }, { once: true });
    media.load();
    media.play().catch(function() {});
  }

  var eagerBudget = window.matchMedia('(max-width: 700px)').matches ? 8 : 16;
  var eagerLoaded = 0;
  Array.prototype.forEach.call(tiles, function(tile) {
    var media = tile.querySelector('.collage-media');
    if (!media) return;
    if (media.dataset.eager === '1' && eagerLoaded < eagerBudget) {
      eagerLoaded += 1;
      loadTile(tile);
    }
  });

  if (!('IntersectionObserver' in window)) {
    Array.prototype.forEach.call(tiles, loadTile);
    return;
  }

  var observer = new IntersectionObserver(function(entries) {
    entries.forEach(function(entry) {
      if (!entry.isIntersecting) return;
      loadTile(entry.target);
      observer.unobserve(entry.target);
    });
  }, { rootMargin: '220px 0px' });

  Array.prototype.forEach.call(tiles, function(tile) {
    if (tile.dataset.loading !== '1') observer.observe(tile);
  });

  function createTile(item) {
    var tile = document.createElement('div');
    tile.className = 'collage-tile';
    tile.style.setProperty('--tile-ratio', item.aspect_ratio || '1 / 1');

    var skeleton = document.createElement('div');
    skeleton.className = 'collage-skeleton';
    tile.appendChild(skeleton);

    if (item.kind === 'video') {
      var video = document.createElement('video');
      video.className = 'collage-media';
      video.autoplay = true;
      video.loop = true;
      video.muted = true;
      video.playsInline = true;
      video.preload = 'none';
      video.poster = '/static/references/anky-1.png';

      var source = document.createElement('source');
      source.type = 'video/mp4';
      source.dataset.src = item.url;
      video.appendChild(source);
      tile.appendChild(video);
    } else {
      var img = document.createElement('img');
      img.className = 'collage-media';
      img.loading = 'lazy';
      img.alt = '';
      img.dataset.src = item.url;
      tile.appendChild(img);
    }
    return tile;
  }

  function scheduleDeferredAppend() {
    if (!deferred || !deferred.length) return;
    var chunk = window.matchMedia('(max-width: 700px)').matches ? 4 : 8;
    var idx = 0;
    function appendChunk() {
      var end = Math.min(idx + chunk, deferred.length);
      for (; idx < end; idx += 1) {
        var tile = createTile(deferred[idx]);
        collage.appendChild(tile);
        observer.observe(tile);
      }
      if (idx < deferred.length) {
        setTimeout(function() {
          if ('requestIdleCallback' in window) {
            requestIdleCallback(appendChunk, { timeout: 1200 });
          } else {
            appendChunk();
          }
        }, 180);
      }
    }
    setTimeout(function() {
      if ('requestIdleCallback' in window) {
        requestIdleCallback(appendChunk, { timeout: 1200 });
      } else {
        appendChunk();
      }
    }, 900);
  }

  scheduleDeferredAppend();
})();
</script>
<div class="countdown-overlay" id="countdown-overlay" style="display:none;">
  <div class="countdown-number" id="countdown-number">8</div>
  <div class="countdown-label">going live in...</div>
</div>

<script>
(function() {
  var textarea = document.getElementById('writing-area');
  var landingTrigger = document.getElementById('landing-trigger');
  var statWords = document.getElementById('stat-words');
  var statTime = document.getElementById('stat-time');
  var lifeBar = document.getElementById('life-bar');
  var chatContainer = document.getElementById('chat-container');
  var sessionProgress = document.getElementById('session-progress');
  var sessionComments = document.getElementById('session-comments');

  var sessionActive = false;
  var sessionStartTime = null;
  var lastKeystrokeTime = null;
  var blockedCount = 0;
  var animFrame = null;

  var TOTAL_SECONDS = 480;
  var IDLE_TIMEOUT = 8000;
  var CHECKPOINT_INTERVAL = 30000;
  var checkpointTimer = null;
  var sessionId = null;
  var sessionToken = null;

  function enterWritingMode(seedText) {
    if (!document.body.classList.contains('home-prewrite')) return;
    document.body.classList.remove('home-prewrite');
    document.body.classList.add('writing-active');
    textarea.style.display = 'block';
    var chat = document.getElementById('chat-container');
    if (chat) chat.style.display = 'none';
    textarea.focus();
    if (seedText && seedText.trim()) {
      textarea.value = seedText;
      textarea.dispatchEvent(new Event('input', { bubbles: true }));
    }
  }

  if (landingTrigger) {
    landingTrigger.addEventListener('focus', function() { enterWritingMode(landingTrigger.value); }, { once: true });
    landingTrigger.addEventListener('click', function() { enterWritingMode(landingTrigger.value); }, { once: true });
    landingTrigger.addEventListener('touchstart', function() { enterWritingMode(landingTrigger.value); }, { once: true });
  }

  function escapeHtml(s) {
    var div = document.createElement('div');
    div.textContent = s;
    return div.innerHTML;
  }

  function showCheckpoint(msg) {
    sessionComments.textContent = msg;
    sessionComments.classList.add('visible');
    setTimeout(function() { sessionComments.classList.remove('visible'); }, 4000);
  }

  function saveCheckpoint() {
    if (!sessionActive || !textarea.value) return;
    var elapsed = (Date.now() - sessionStartTime) / 1000;
    if (!sessionId) sessionId = 'ses_' + Date.now().toString(36);
    var payload = { session_id: sessionId, text: textarea.value, elapsed: elapsed };
    if (sessionToken) payload.session_token = sessionToken;
    fetch('/api/checkpoint', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    }).then(function(r) { return r.json(); }).then(function(data) {
      if (data.session_token) sessionToken = data.session_token;
    }).catch(function() {});
    showCheckpoint('checkpoint saved');
  }

  function animate() {
    if (!sessionActive) return;
    var elapsed = (Date.now() - sessionStartTime) / 1000;

    var mins = Math.floor(elapsed / 60);
    var secs = Math.floor(elapsed % 60);
    statTime.textContent = mins + ':' + (secs < 10 ? '0' : '') + secs;
    if (elapsed >= TOTAL_SECONDS) {
      statTime.className = 'stat-time-done';
    }

    var progressPct = Math.min((elapsed / TOTAL_SECONDS) * 100, 100);
    sessionProgress.style.width = progressPct + '%';
    if (progressPct >= 100) {
      sessionProgress.classList.add('complete');
      if (!document.getElementById('anky-accomplished-text')) {
        var badge = document.createElement('span');
        badge.id = 'anky-accomplished-text';
        badge.className = 'anky-accomplished';
        badge.textContent = 'anky accomplished';
        sessionComments.parentNode.insertBefore(badge, sessionComments.parentNode.firstChild.nextSibling);
      }
    }

    var sinceLastKey = Date.now() - lastKeystrokeTime;
    if (sinceLastKey < 3000) {
      lifeBar.style.opacity = '0';
    } else {
      lifeBar.style.opacity = '1';
      var ratio = 1 - sinceLastKey / IDLE_TIMEOUT;
      if (ratio < 0) ratio = 0;
      lifeBar.style.width = (ratio * 100) + '%';
    }

    if (sinceLastKey >= IDLE_TIMEOUT) {
      endSession();
      return;
    }
    animFrame = requestAnimationFrame(animate);
  }

  function startSession() {
    sessionActive = true;
    sessionStartTime = Date.now();
    lastKeystrokeTime = Date.now();
    blockedCount = 0;
    sessionId = 'ses_' + Date.now().toString(36);
    sessionToken = null;

    document.body.classList.add('writing-active');
    textarea.classList.add('writing-engaged');

    if (window.ankyLive && window.ankyLive.setSessionActive) {
      window.ankyLive.setSessionActive(true);
    }

    animate();
    checkpointTimer = setInterval(saveCheckpoint, CHECKPOINT_INTERVAL);
  }

  var currentAnkyId = null;
  var chatHistory = [];
  var currentWritingText = '';
  var lastStreamedTitle = '';
  var lastStreamedReflection = '';

  function scrollChatToBottom() {
    setTimeout(function() { chatContainer.scrollTop = chatContainer.scrollHeight; }, 50);
  }

  function addChatBubble(role, html, opts) {
    var bubble = document.createElement('div');
    bubble.className = 'chat-bubble ' + role;
    bubble.innerHTML = html;
    chatContainer.appendChild(bubble);
    if (role === 'user' && opts && opts.collapsible && html.length > 500) {
      bubble.classList.add('collapsed');
      var btn = document.createElement('button');
      btn.className = 'chat-bubble-expand';
      btn.textContent = 'show full writing';
      btn.onclick = function() {
        if (bubble.classList.contains('collapsed')) {
          bubble.classList.remove('collapsed');
          btn.textContent = 'collapse';
        } else {
          bubble.classList.add('collapsed');
          btn.textContent = 'show full writing';
        }
        scrollChatToBottom();
      };
      chatContainer.appendChild(btn);
    }
    scrollChatToBottom();
    return bubble;
  }

  function renderMarkdown(text) {
    return text
      .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
      .replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>')
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.+?)\*/g, '<em>$1</em>')
      .replace(/^### (.+)$/gm, '<h4>$1</h4>')
      .replace(/^## (.+)$/gm, '<h3>$1</h3>')
      .replace(/^# (.+)$/gm, '<h3>$1</h3>')
      .replace(/\n\n+/g, '</p><p>')
      .replace(/\n/g, '<br>');
  }

  function streamAnkyReflection(ankyId) {
    var ankyBubble = document.getElementById('anky-bubble');
    var fullText = '';
    var titleParsed = false;
    var titleText = '';
    var renderPending = false;

    function renderCurrentText() {
      if (!titleParsed && fullText.indexOf('\n') !== -1) {
        titleText = fullText.substring(0, fullText.indexOf('\n')).trim();
        titleParsed = true;
        lastStreamedTitle = titleText;
      }
      lastStreamedReflection = fullText;
      if (titleParsed) {
        var rest = fullText.substring(fullText.indexOf('\n') + 1).trim();
        ankyBubble.innerHTML =
          '<div class="anky-chat-title">' + escapeHtml(titleText) + '</div>' +
          '<span class="anky-response-text">' + renderMarkdown(rest) + '</span>';
      } else if (fullText) {
        ankyBubble.innerHTML =
          '<span class="anky-response-text">' + escapeHtml(fullText) + '</span>';
      }
      scrollChatToBottom();
    }

    var source = new EventSource('/api/stream-reflection/' + ankyId);
    source.onmessage = function(e) {
      fullText += e.data;
      if (!renderPending) {
        renderPending = true;
        requestAnimationFrame(function() {
          renderCurrentText();
          renderPending = false;
        });
      }
    };
    source.addEventListener('done', function() {
      source.close();
      renderCurrentText();
      pollAnkyImage(ankyId);
    });
    source.onerror = function() {
      source.close();
      if (!fullText) pollAnkyReflection(ankyId);
      else { renderCurrentText(); pollAnkyImage(ankyId); }
    };
  }

  function makeInlineShareHtml(ankyId) {
    var url = window.location.origin + '/anky/' + ankyId;
    return '<div class="anky-inline-share">' +
      '<button class="anky-inline-share-btn" onclick="if(navigator.share){navigator.share({title:\'my anky\',url:\'' + url + '\'}).catch(function(){})}else{navigator.clipboard.writeText(\'' + url + '\').then(function(){this.textContent=\'copied!\';var b=this;setTimeout(function(){b.textContent=\'share\'},2000)}.bind(this))}">share</button>' +
      '<button class="anky-inline-share-btn anky-inline-share-dim" onclick="navigator.clipboard.writeText(\'' + url + '\').then(function(){this.textContent=\'copied!\';var b=this;setTimeout(function(){b.textContent=\'copy link\'},2000)}.bind(this))">copy link</button>' +
      '</div>';
  }

  function pollAnkyImage(ankyId) {
    var pollCount = 0;
    var interval = setInterval(function() {
      pollCount++;
      fetch('/api/v1/anky/' + ankyId)
        .then(function(r) { return r.json(); })
        .then(function(data) {
          var imgEl = document.getElementById('anky-inline-image');
          if (data.status === 'complete' && data.image_url) {
            clearInterval(interval);
            var shareHtml = makeInlineShareHtml(ankyId);
            if (imgEl) {
              imgEl.innerHTML = '<img src="' + data.image_url + '" alt="your anky" class="anky-chat-img" />' + shareHtml;
            } else {
              addChatBubble('anky', '<img src="' + data.image_url + '" alt="your anky" class="anky-chat-img" />' + shareHtml);
            }
            showChatInput();
          } else if (data.status === 'failed') {
            clearInterval(interval);
            if (imgEl) imgEl.innerHTML = '<span class="error">image generation failed.</span>';
            showChatInput();
          }
          if (pollCount > 100) clearInterval(interval);
        })
        .catch(function() {});
    }, 3000);
  }

  function pollAnkyReflection(ankyId) {
    var ankyBubble = document.getElementById('anky-bubble');
    var pollCount = 0;
    var reflectionShown = false;
    var interval = setInterval(function() {
      pollCount++;
      fetch('/api/v1/anky/' + ankyId)
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.reflection && !reflectionShown) {
            reflectionShown = true;
            lastStreamedTitle = data.title || '';
            lastStreamedReflection = data.reflection || '';
            ankyBubble.innerHTML = '<span class="anky-response-text">' + renderMarkdown(data.reflection) + '</span>';
            if (data.title) {
              ankyBubble.innerHTML = '<div class="anky-chat-title">' + escapeHtml(data.title) + '</div>' + ankyBubble.innerHTML;
            }
            scrollChatToBottom();
          }
          var imgEl = document.getElementById('anky-inline-image');
          if (data.status === 'complete' && data.image_url) {
            clearInterval(interval);
            var shareHtml = makeInlineShareHtml(ankyId);
            if (imgEl) {
              imgEl.innerHTML = '<img src="' + data.image_url + '" alt="your anky" class="anky-chat-img" />' + shareHtml;
            } else {
              addChatBubble('anky', '<img src="' + data.image_url + '" alt="your anky" class="anky-chat-img" />' + shareHtml);
            }
            showChatInput();
          } else if (data.status === 'failed') {
            clearInterval(interval);
            if (imgEl) imgEl.innerHTML = '<span class="error">image generation failed.</span>';
            showChatInput();
          }
          if (pollCount > 100) clearInterval(interval);
        })
        .catch(function() {});
    }, 3000);
  }

  function createChatInputArea(sendMessageFn) {
    if (document.getElementById('chat-input-area')) return;
    var inputArea = document.createElement('div');
    inputArea.id = 'chat-input-area';
    inputArea.className = 'chat-input-area';
    inputArea.innerHTML =
      '<textarea id="chat-input" class="chat-input" placeholder="continue writing..." rows="1" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" data-gramm="false" data-gramm_editor="false" data-enable-grammarly="false"></textarea>' +
      '<button id="chat-send" class="chat-send-btn" disabled>send</button>';
    var writingMain = document.querySelector('.writing-main');
    writingMain.appendChild(inputArea);

    var input = document.getElementById('chat-input');
    var sendBtn = document.getElementById('chat-send');
    input.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        if (input.value.trim()) sendBtn.click();
      }
    });
    input.addEventListener('input', function() {
      input.style.height = 'auto';
      input.style.height = Math.min(input.scrollHeight, 200) + 'px';
      sendBtn.disabled = !input.value.trim();
    });
    sendBtn.onclick = function() { sendMessageFn(input, sendBtn); };
    input.focus();
    scrollChatToBottom();
  }

  function showChatInput() {
    createChatInputArea(function(input, sendBtn) {
      var msg = input.value.trim();
      if (!msg || !currentAnkyId) return;
      input.value = '';
      input.style.height = 'auto';
      sendBtn.disabled = true;
      addChatBubble('user', escapeHtml(msg));
      var thinking = addChatBubble('anky', '<span class="processing">thinking...</span>');
      fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ anky_id: currentAnkyId, message: msg, history: chatHistory }),
      })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          chatHistory.push({ role: 'user', content: msg });
          chatHistory.push({ role: 'assistant', content: data.response });
          thinking.innerHTML = '<span class="anky-response-text">' + renderMarkdown(data.response) + '</span>';
          sendBtn.disabled = !input.value.trim();
          input.focus();
          scrollChatToBottom();
        })
        .catch(function() {
          thinking.innerHTML = '<span class="error">something went wrong.</span>';
          sendBtn.disabled = !input.value.trim();
        });
    });
  }

  function showQuickChatInput() {
    createChatInputArea(function(input, sendBtn) {
      var msg = input.value.trim();
      if (!msg) return;
      input.value = '';
      input.style.height = 'auto';
      sendBtn.disabled = true;
      addChatBubble('user', escapeHtml(msg));
      var thinking = addChatBubble('anky', '<span class="processing">thinking...</span>');
      fetch('/api/chat-quick', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ writing: currentWritingText, message: msg, history: chatHistory }),
      })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          chatHistory.push({ role: 'user', content: msg });
          chatHistory.push({ role: 'assistant', content: data.response });
          thinking.innerHTML = '<span class="anky-response-text">' + renderMarkdown(data.response) + '</span>';
          sendBtn.disabled = !input.value.trim();
          input.focus();
          scrollChatToBottom();
        })
        .catch(function() {
          thinking.innerHTML = '<span class="error">something went wrong.</span>';
          sendBtn.disabled = !input.value.trim();
        });
    });
  }

  function endSession() {
    if (!sessionActive) return;
    sessionActive = false;
    if (animFrame) cancelAnimationFrame(animFrame);
    if (checkpointTimer) { clearInterval(checkpointTimer); checkpointTimer = null; }
    sessionComments.classList.remove('visible');
    lifeBar.style.width = '0%';
    lifeBar.style.opacity = '0';

    if (window.ankyLive && window.ankyLive.isLive()) window.ankyLive.disconnect();
    if (window.ankyLive && window.ankyLive.setSessionActive) window.ankyLive.setSessionActive(false);

    var duration = (Date.now() - sessionStartTime) / 1000;
    var text = textarea.value;
    currentWritingText = text;
    chatHistory = [];
    currentAnkyId = null;

    sessionProgress.style.width = '0%';
    sessionProgress.classList.remove('complete');
    var accomplishedText = document.getElementById('anky-accomplished-text');
    if (accomplishedText) accomplishedText.remove();

    document.body.classList.remove('writing-active');
    document.body.classList.add('chat-active');
    textarea.style.display = 'none';
    chatContainer.style.display = 'flex';
    chatContainer.innerHTML = '';

    addChatBubble('user', escapeHtml(text), { collapsible: true });
    addChatBubble('anky', '<span class="processing">processing...</span>').id = 'anky-bubble';

    var inquiryEl = document.getElementById('inquiry-prompt');
    var inquiryId = inquiryEl ? inquiryEl.getAttribute('data-inquiry-id') : null;
    var writePayload = { text: text, duration: duration };
    if (inquiryId) writePayload.inquiry_id = inquiryId;

    fetch('/write', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(writePayload),
    })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        var ankyBubble = document.getElementById('anky-bubble');
        if (data.error) {
          ankyBubble.innerHTML = '<span class="error">' + escapeHtml(data.error) + '</span>';
          setTimeout(function() { showQuickChatInput(); }, 500);
          return;
        }
        if (data.is_anky && data.anky_id) {
          currentAnkyId = data.anky_id;
          ankyBubble.innerHTML = '<span class="processing">anky is reading your writing...</span>';
          addChatBubble('anky', '<div id="anky-inline-image" class="anky-image-skeleton"><div class="skeleton-pulse"></div></div>');
          streamAnkyReflection(data.anky_id);
        } else {
          ankyBubble.innerHTML = '<span class="anky-response-text">' + renderMarkdown(data.response) + '</span>';
          scrollChatToBottom();
          setTimeout(function() { showQuickChatInput(); }, 1500);
        }
      })
      .catch(function() {
        var ankyBubble = document.getElementById('anky-bubble');
        ankyBubble.innerHTML = '<span class="error">something went wrong.</span>';
        setTimeout(function() { showQuickChatInput(); }, 500);
      });
  }

  textarea.addEventListener('input', function() {
    textarea.selectionStart = textarea.selectionEnd = textarea.value.length;
    if (!sessionActive) startSession();
    else lastKeystrokeTime = Date.now();
    var words = textarea.value.split(/\s+/).filter(function(w) { return w.length > 0; }).length;
    statWords.textContent = words + (words === 1 ? ' word' : ' words');
    if (window.ankyLive && window.ankyLive.isLive()) {
      var wordCount = textarea.value.split(/\s+/).filter(function(w) { return w.length > 0; }).length;
      window.ankyLive.sendText(textarea.value, {
        words: wordCount,
        elapsed: (Date.now() - sessionStartTime) / 1000,
        idle_ratio: Math.max(0, 1 - (Date.now() - lastKeystrokeTime) / IDLE_TIMEOUT),
        progress: Math.min(((Date.now() - sessionStartTime) / 1000) / TOTAL_SECONDS, 1)
      });
    }
  });

  textarea.addEventListener('keydown', function(e) {
    var blocked = ['Backspace', 'Delete', 'Enter', 'Tab',
      'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Home', 'End'];
    if (blocked.indexOf(e.key) !== -1) {
      e.preventDefault();
      blockedCount++;
      textarea.classList.remove('blocked-flash');
      void textarea.offsetWidth;
      textarea.classList.add('blocked-flash');
      return;
    }
    if ((e.ctrlKey || e.metaKey) && 'axzy'.indexOf(e.key.toLowerCase()) !== -1) {
      e.preventDefault();
      blockedCount++;
      textarea.classList.remove('blocked-flash');
      void textarea.offsetWidth;
      textarea.classList.add('blocked-flash');
    }
  });

  function blockAndCount(e) { e.preventDefault(); blockedCount++; }
  textarea.addEventListener('paste', blockAndCount);
  textarea.addEventListener('cut', blockAndCount);
  textarea.addEventListener('drop', blockAndCount);
})();

// Auto-focus writing textarea on page load
setTimeout(function() {
  if (document.body.classList.contains('home-prewrite')) return;
  var ta = document.getElementById('writing-area');
  if (ta) ta.focus();
}, 100);

// Mobile viewport height — tracks visual viewport so keyboard doesn't break layout
(function() {
  function updateVH() {
    var vh = window.visualViewport ? window.visualViewport.height : window.innerHeight;
    document.documentElement.style.setProperty('--vh', vh + 'px');
  }
  if (window.visualViewport) {
    window.visualViewport.addEventListener('resize', function() {
      updateVH();
      // Pin scroll to top — prevents iOS viewport shift when keyboard opens
      window.scrollTo(0, 0);
      document.documentElement.scrollTop = 0;
      document.body.scrollTop = 0;
    });
    window.visualViewport.addEventListener('scroll', function() {
      window.scrollTo(0, 0);
      document.documentElement.scrollTop = 0;
      document.body.scrollTop = 0;
    });
  }
  window.addEventListener('resize', updateVH);
  window.addEventListener('orientationchange', function() {
    setTimeout(updateVH, 200);
  });
  // Prevent pull-to-refresh and overscroll bounce
  document.addEventListener('touchmove', function(e) {
    // Allow scrolling inside the textarea and chat container
    var el = e.target;
    while (el && el !== document.body) {
      if (
        el.id === 'writing-area' ||
        el.id === 'chat-container' ||
        el.id === 'landing-shell' ||
        el.classList.contains('chat-container') ||
        el.classList.contains('landing-content')
      ) return;
      el = el.parentElement;
    }
    e.preventDefault();
  }, { passive: false });
  updateVH();
})();

// GO LIVE streaming
window.ankyLive = (function() {
  var ws = null;
  var liveActive = false;
  var navBtn = document.getElementById('go-live-navbar-btn');
  var countdownOverlay = document.getElementById('countdown-overlay');
  var countdownNumber = document.getElementById('countdown-number');
  var sseSource = null;
  var slotTaken = false;
  var sessionActive = false;

  function updateBtn() {
    if (!navBtn) return;
    var walletConnected = window.ankyWallet && window.ankyWallet.isLoggedIn && window.ankyWallet.isLoggedIn();
    if (!walletConnected) { navBtn.style.display = 'none'; return; }
    if (liveActive) {
      navBtn.textContent = 'LIVE'; navBtn.className = 'go-live-navbar-btn live-active'; navBtn.style.display = '';
      navBtn.disabled = false; navBtn.onclick = function() { disconnect(); };
    } else if (slotTaken || sessionActive) { navBtn.style.display = 'none'; }
    else {
      navBtn.textContent = 'GO LIVE'; navBtn.className = 'go-live-navbar-btn'; navBtn.style.display = '';
      navBtn.disabled = false; navBtn.onclick = function() { goLive(); };
    }
  }
  function setSessionActive(val) { sessionActive = val; updateBtn(); }
  function subscribeStatus() {
    if (sseSource) return;
    sseSource = new EventSource('/api/live-status');
    sseSource.onmessage = function(e) {
      try { var data = JSON.parse(e.data); if (!liveActive) { slotTaken = data.is_live; updateBtn(); } } catch(_) {}
    };
    sseSource.onerror = function() { sseSource.close(); sseSource = null; setTimeout(subscribeStatus, 5000); };
  }
  function connect() {
    var proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
    ws = new WebSocket(proto + '//' + location.host + '/ws/live');
    ws.onopen = function() { liveActive = true; slotTaken = false; updateBtn(); };
    ws.onmessage = function(e) { try { var data = JSON.parse(e.data); if (data.type === 'error') { slotTaken = true; liveActive = false; updateBtn(); ws.close(); ws = null; } } catch(_) {} };
    ws.onclose = function() { liveActive = false; ws = null; updateBtn(); };
    ws.onerror = function() { liveActive = false; ws = null; updateBtn(); };
  }
  function disconnect() { if (ws) { ws.close(); ws = null; } liveActive = false; updateBtn(); }
  function goLive() {
    if (!window.ankyWallet || !window.ankyWallet.isLoggedIn()) { alert('login first'); updateBtn(); return; }
    countdownOverlay.style.display = 'flex';
    var count = 8;
    countdownNumber.textContent = count;
    if (navBtn) navBtn.style.display = 'none';
    var countdownTimer = setInterval(function() {
      count--;
      if (count <= 0) {
        clearInterval(countdownTimer); countdownOverlay.style.display = 'none';
        connect();
        var ta = document.getElementById('writing-area');
        if (ta) ta.focus();
      } else { countdownNumber.textContent = count; }
    }, 1000);
  }
  function sendText(text, stats) {
    if (ws && ws.readyState === WebSocket.OPEN) {
      var msg = { type: 'text', content: text };
      if (stats) { msg.words = stats.words; msg.elapsed = stats.elapsed; msg.idle_ratio = stats.idle_ratio; msg.progress = stats.progress; }
      ws.send(JSON.stringify(msg));
    }
  }
  function isLive() { return liveActive; }
  subscribeStatus();
  window.addEventListener('anky:wallet-changed', updateBtn);
  updateBtn();
  return { toggle: function() { if (liveActive) disconnect(); else goLive(); }, sendText: sendText, isLive: isLive, disconnect: disconnect, setSessionActive: setSessionActive, startCountdown: goLive };
})();
</script>
{% endblock %}
