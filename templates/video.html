{% extends "base.html" %}

{% block title %}ANKY — Video Production Studio{% endblock %}

{% block head %}
<meta property="og:title" content="ANKY — Learn How To Focus">
<meta property="og:description" content="A 2:22 video about writing yourself free. pump.fun Build in Public hackathon.">
<meta property="og:image" content="https://anky.app/og/video">
<meta property="og:type" content="video.other">
<meta property="og:url" content="https://anky.app/generate/video">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@jpfraneto">
<meta name="twitter:title" content="ANKY — Learn How To Focus">
<meta name="twitter:description" content="A 2:22 video about writing yourself free. pump.fun Build in Public hackathon.">
<meta name="twitter:image" content="https://anky.app/og/video">
{% endblock %}

{% block content %}
<div class="studio-container" id="studio">

<!-- ==================== PHASE: PREP ==================== -->
<div class="studio-phase" id="phase-prep">
  <h1 class="studio-title">ANKY — Video Production Studio</h1>
  <p class="studio-subtitle">Generate images, then record yourself reading the script with teleprompter.</p>

  <div class="studio-actions-top">
    <button class="studio-btn studio-btn-primary" id="btn-start-recording">START RECORDING</button>
    <button class="studio-btn studio-btn-secondary" id="btn-generate-all" style="margin-left:12px;">GENERATE ALL IMAGES</button>
  </div>

  <!-- Script -->
  <div class="studio-section">
    <h2 class="studio-section-title">Script</h2>

    <details class="studio-act" open>
      <summary>
        <span><span class="studio-act-title">Act 1: The Savior Pattern</span><span class="studio-act-time">0:00 — 0:50</span></span>
      </summary>
      <div class="studio-act-content">
        <p class="direction">[Live-action. Jorge talking directly to camera. Tight frame on face. Intensity building.]</p>
        <p>You sit down to write and the first thing that comes is: "I need to save the world."</p>
        <p>Every time. The savior pattern. You can't just write — you have to matter. You have to be special. You have to have a mission.</p>
        <p>And so you write about saving the world instead of actually writing. Instead of actually being here. Instead of actually feeling what's happening right now.</p>
        <p>What if the whole point was never to save anyone?</p>
        <p>What if the whole point was to sit with yourself long enough that the self dissolves?</p>
        <p class="direction">[Camera slowly pushes in. Background starts glitching subtly.]</p>
        <p>Eight minutes. That's all it takes. Eight minutes of pure stream of consciousness and something cracks open.</p>
        <p>Not because eight minutes is magic. But because eight minutes is long enough that your ego runs out of things to say.</p>
      </div>
    </details>

    <details class="studio-act">
      <summary>
        <span><span class="studio-act-title">Act 2: The Crack</span><span class="studio-act-time">0:50 — 0:55</span></span>
      </summary>
      <div class="studio-act-content">
        <p class="direction">[5-second psychedelic glitch transition. Reality cracks open. Visual: fractal patterns, the screen tears, reality dissolves into the Ankyverse.]</p>
        <p class="direction">[Sound: a deep resonant hum, glass shattering in reverse, then silence.]</p>
      </div>
    </details>

    <details class="studio-act">
      <summary>
        <span><span class="studio-act-title">Act 3: The Ankyverse</span><span class="studio-act-time">0:55 — 1:55</span></span>
      </summary>
      <div class="studio-act-content">
        <p class="direction">[Two small blue Ankys sitting in a cosmic living room. They're watching Jorge on a screen embedded in what looks like a living crystal. The room breathes. Stars drift through the walls.]</p>
        <p><strong>Anky 1:</strong> There he goes again.</p>
        <p><strong>Anky 2:</strong> The savior thing?</p>
        <p><strong>Anky 1:</strong> Always the savior thing. He sits down, and the first thought is always "I need to change everything."</p>
        <p><strong>Anky 2:</strong> <em>(laughing softly)</em> He doesn't see it yet, does he?</p>
        <p><strong>Anky 1:</strong> That the writing IS the transformation? No. He thinks he needs to produce something. Ship something. Build something that matters.</p>
        <p><strong>Anky 2:</strong> And the whole time, the sitting IS the thing.</p>
        <p><strong>Anky 1:</strong> Eight minutes of just... being. No agenda. No product. No audience. Just consciousness meeting itself on the page.</p>
        <p><strong>Anky 2:</strong> He'll get it. He always gets it. It just takes him the full eight minutes every time.</p>
        <p><strong>Anky 1:</strong> <em>(cosmic laughter)</em> That's the beautiful part. The pattern has to play itself out completely before it can dissolve.</p>
        <p class="direction">[The Ankys watch as Jorge on the screen starts to soften. His writing changes. The intensity drops. Something real starts coming through.]</p>
        <p><strong>Anky 2:</strong> There it is.</p>
        <p><strong>Anky 1:</strong> There it is.</p>
      </div>
    </details>

    <details class="studio-act">
      <summary>
        <span><span class="studio-act-title">Act 4: The Return</span><span class="studio-act-time">1:55 — 2:15</span></span>
      </summary>
      <div class="studio-act-content">
        <p class="direction">[Back to live footage. Jorge's face is different now. Relaxed. Soft. The intensity is gone. He's just... here.]</p>
        <p>You don't need to save the world.</p>
        <p>You just need to write for eight minutes.</p>
        <p>The rest takes care of itself.</p>
        <p class="direction">[Gentle smile. Looks directly at camera. Pause.]</p>
        <p>anky.app</p>
      </div>
    </details>

    <details class="studio-act">
      <summary>
        <span><span class="studio-act-title">Act 5: End Card</span><span class="studio-act-time">2:15 — 2:22</span></span>
      </summary>
      <div class="studio-act-content">
        <p class="direction">[Black background. Single Anky meditating in center frame. Golden spiral patterns emanating outward. Breathing light.]</p>
        <p style="text-align:center; color:#d4a853; font-size:20px;">ANKY</p>
        <p style="text-align:center; color:#c8c8d4;">learn how to focus</p>
        <p style="text-align:center; color:#666; font-size:12px;">anky.app</p>
      </div>
    </details>
  </div>

  <!-- Image Generation Grid -->
  <div class="studio-section">
    <h2 class="studio-section-title">Image Generation <span class="studio-gen-count" id="gen-count">0/17</span></h2>
    <div class="studio-image-grid" id="image-grid"></div>
  </div>
</div>

<!-- ==================== PHASE: RECORD ==================== -->
<div class="studio-phase" id="phase-record" style="display:none;">
  <!-- Countdown overlay -->
  <div class="studio-countdown" id="countdown-overlay" style="display:none;">
    <span class="studio-countdown-number" id="countdown-number">3</span>
  </div>

  <!-- Camera PIP -->
  <video class="studio-camera-pip" id="camera-pip" autoplay muted playsinline></video>

  <!-- Timer overlay -->
  <div class="studio-timer-overlay">
    <div class="studio-timer-elapsed" id="timer-elapsed">0:00</div>
    <div class="studio-timer-act" id="timer-act">Act 1: The Savior Pattern</div>
    <div class="studio-progress-bar">
      <div class="studio-progress-fill" id="progress-fill"></div>
    </div>
  </div>

  <!-- Teleprompter -->
  <div class="studio-teleprompter" id="teleprompter">
    <div class="studio-teleprompter-text" id="teleprompter-text"></div>
  </div>

  <!-- Stop button -->
  <button class="studio-btn studio-btn-stop" id="btn-stop">STOP</button>
</div>

<!-- ==================== PHASE: REVIEW ==================== -->
<div class="studio-phase" id="phase-review" style="display:none;">
  <h1 class="studio-title">Review Recording</h1>

  <div class="studio-review-player">
    <video class="studio-review-video" id="review-video" controls playsinline></video>
  </div>

  <!-- Timeline -->
  <div class="studio-timeline" id="timeline">
    <div class="studio-timeline-bar">
      <div class="studio-timeline-marker" style="left:0%" title="Act 1">1</div>
      <div class="studio-timeline-marker" style="left:35.2%" title="Act 2">2</div>
      <div class="studio-timeline-marker" style="left:38.7%" title="Act 3">3</div>
      <div class="studio-timeline-marker" style="left:81%" title="Act 4">4</div>
      <div class="studio-timeline-marker" style="left:95%" title="Act 5">5</div>
    </div>
  </div>

  <div class="studio-review-actions">
    <button class="studio-btn studio-btn-primary" id="btn-upload">UPLOAD</button>
    <button class="studio-btn studio-btn-secondary" id="btn-restart">RESTART</button>
  </div>

  <div class="studio-upload-status" id="upload-status" style="display:none;"></div>
</div>

</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
  // ===== Script Data =====
  var SCRIPT = {
    target_duration: 142,
    acts: [
      { id: "act-1", title: "The Savior Pattern", start: 0, end: 50, lines: [
        "You sit down to write and the first thing that comes is: \"I need to save the world.\"",
        "Every time. The savior pattern. You can't just write — you have to matter. You have to be special. You have to have a mission.",
        "And so you write about saving the world instead of actually writing. Instead of actually being here. Instead of actually feeling what's happening right now.",
        "What if the whole point was never to save anyone?",
        "What if the whole point was to sit with yourself long enough that the self dissolves?",
        "Eight minutes. That's all it takes. Eight minutes of pure stream of consciousness and something cracks open.",
        "Not because eight minutes is magic. But because eight minutes is long enough that your ego runs out of things to say."
      ]},
      { id: "act-2", title: "The Crack", start: 50, end: 55, lines: [
        "[5-second psychedelic glitch transition]"
      ]},
      { id: "act-3", title: "The Ankyverse", start: 55, end: 115, lines: [
        "Anky 1: There he goes again.",
        "Anky 2: The savior thing?",
        "Anky 1: Always the savior thing. He sits down, and the first thought is always \"I need to change everything.\"",
        "Anky 2: He doesn't see it yet, does he?",
        "Anky 1: That the writing IS the transformation? No. He thinks he needs to produce something. Ship something. Build something that matters.",
        "Anky 2: And the whole time, the sitting IS the thing.",
        "Anky 1: Eight minutes of just... being. No agenda. No product. No audience. Just consciousness meeting itself on the page.",
        "Anky 2: He'll get it. He always gets it. It just takes him the full eight minutes every time.",
        "Anky 1: That's the beautiful part. The pattern has to play itself out completely before it can dissolve.",
        "Anky 2: There it is.",
        "Anky 1: There it is."
      ]},
      { id: "act-4", title: "The Return", start: 115, end: 135, lines: [
        "You don't need to save the world.",
        "You just need to write for eight minutes.",
        "The rest takes care of itself.",
        "anky.app"
      ]},
      { id: "act-5", title: "End Card", start: 135, end: 142, lines: [
        "ANKY",
        "learn how to focus",
        "anky.app"
      ]}
    ],
    prompts: [
      { id: "01-reality-crack", name: "Reality Crack", act: "act-2", priority: "critical", text: "A photorealistic close-up of a human face (Jorge, Latino man, short dark hair, slight beard) as reality cracks around him. The skin begins to fragment like broken glass, revealing swirling cosmic purple and gold energy beneath. Fractal patterns emerge from the cracks. The background dissolves into psychedelic geometry. Dramatic lighting, cinematic, 8K detail. The expression is one of surrender, not fear. Aspect ratio 16:9." },
      { id: "02-fractal-dissolution", name: "Fractal Dissolution", act: "act-2", priority: "important", text: "Abstract psychedelic fractal art. Deep space blues and purples fragmenting into golden spiral patterns. No recognizable forms — pure geometric dissolution. Sacred geometry emerging from chaos. Think Alex Grey meets deep space telescope imagery. Bioluminescent tendrils of light weaving through crystalline structures. 16:9 aspect ratio, ultra-detailed." },
      { id: "03-portal-opening", name: "Portal Opening", act: "act-2", priority: "important", text: "A circular portal opening in the fabric of reality. The edges are made of golden spiral fractals. Through the portal, a warm cosmic living room is visible — soft glowing furniture, stars drifting through walls, bioluminescent plants. The portal itself emits a deep purple light. The surrounding space is fragmenting and dissolving. Cinematic, painterly style. 16:9." },
      { id: "04-cosmic-living-room-wide", name: "Cosmic Living Room — Wide", act: "act-3", priority: "critical", text: "A wide shot of a cosmic living room floating in deep space. The room has no walls — instead, nebulae and star fields serve as boundaries. Furniture is made of living crystal that breathes with soft light. In the center, two small blue goblin-like creatures with large round expressive eyes, bulbous noses, and distinctive purple brain-caps covered in intricate golden spiral patterns sit on a glowing couch. They face a large crystalline screen showing a human face. Bioluminescent plants float nearby. Warm amber and purple lighting. Fantasy art style, highly detailed, painterly. 16:9." },
      { id: "05-anky1-closeup", name: "Anky 1 Close-up", act: "act-3", priority: "critical", text: "Close-up portrait of a small blue goblin-like creature with large round expressive eyes, a bulbous nose, and a distinctive purple brain-cap covered in intricate golden spiral patterns. The expression is one of loving amusement — a gentle smirk, eyes twinkling with cosmic knowing. The creature sits in a cosmic living room, stars reflecting in its golden/amber glowing eyes. Soft purple and gold lighting. The background is out of focus — nebulae and floating crystals. Fantasy art, painterly, highly detailed. 16:9." },
      { id: "06-anky2-closeup", name: "Anky 2 Close-up", act: "act-3", priority: "critical", text: "Close-up portrait of a small blue goblin-like creature with large round expressive eyes, a bulbous nose, and a distinctive purple brain-cap covered in intricate golden spiral patterns. This one is laughing softly — mouth slightly open, eyes crinkled with joy. Cosmic laughter. The creature has slightly different golden jewelry patterns than its companion. Stars and nebulae reflect in its eyes. Warm amber lighting from nearby bioluminescent plants. Fantasy art, painterly, highly detailed. 16:9." },
      { id: "07-two-ankys-couch", name: "Two Ankys on Couch", act: "act-3", priority: "critical", text: "Medium shot of two small blue goblin-like creatures with large round expressive eyes, bulbous noses, and distinctive purple brain-caps covered in intricate golden spiral patterns. They sit side by side on a living crystal couch that glows with soft amber light. One leans toward the other conspiratorially. They're having an intimate, amused conversation. The cosmic living room surrounds them — no walls, just space and stars. A crystalline screen glows nearby showing a human face. Warm, intimate lighting. Fantasy art, painterly, highly detailed. 16:9." },
      { id: "08-crystal-screen-jorge", name: "Crystal Screen — Jorge", act: "act-3", priority: "important", text: "A living crystal screen embedded in space, showing a close-up of a human man (Latino, short dark hair, slight beard) writing intensely. The screen's edges are organic, crystalline, breathing with light. The image on the screen has a slight ethereal quality — as if seen through water or glass. Around the screen, the cosmic living room is visible in soft focus. Golden light emanates from the crystal. The human's expression is intense, focused, slightly agitated — caught in the savior pattern. 16:9." },
      { id: "09-transformation-moment", name: "The Transformation Moment", act: "act-3", priority: "critical", text: "Split composition: foreground shows two small blue goblin-like creatures with large round expressive eyes, bulbous noses, and distinctive purple brain-caps covered in intricate golden spiral patterns leaning forward with recognition and joy. Background shows a crystal screen where a human face is visibly softening — the intensity melting away, replaced by peace. Golden light radiates from the screen outward, washing over the Ankys. The cosmic living room responds — bioluminescent plants pulse brighter, stars seem to align. A moment of cosmic recognition. Fantasy art, painterly, emotional, 16:9." },
      { id: "10-cosmic-laughter", name: "Cosmic Laughter", act: "act-3", priority: "important", text: "Two small blue goblin-like creatures with large round expressive eyes, bulbous noses, and distinctive purple brain-caps covered in intricate golden spiral patterns, laughing together. True cosmic laughter — golden light particles emanate from their mouths. The laughter creates visible ripples in space around them. Stars dance in response. Their eyes are closed with joy, bodies shaking with mirth. The cosmic living room vibrates with their amusement. Warm, joyful, transcendent. Fantasy art, painterly, luminous. 16:9." },
      { id: "11-ankyverse-wide", name: "Ankyverse Wide", act: "act-3", priority: "optional", text: "Ultra-wide establishing shot of the Ankyverse. An infinite cosmic space where living rooms, libraries, and gardens float like islands in a sea of stars. No ground, no sky — just space in every direction. Each island glows with warm amber light. Bioluminescent pathways connect them like bridges of light. In one of the closer islands, two tiny blue figures are barely visible on a glowing couch. The scale is vast — consciousness made visible. Deep blues, purples, and golds. Fantasy art, painterly, awe-inspiring. 16:9." },
      { id: "12-there-it-is", name: "\"There It Is\" — Recognition", act: "act-3", priority: "critical", text: "Two small blue goblin-like creatures with large round expressive eyes, bulbous noses, and distinctive purple brain-caps covered in intricate golden spiral patterns. They sit still, no longer laughing. Soft, knowing smiles. They look at the crystal screen with deep tenderness. One places a small blue hand on the other's shoulder. The cosmic living room is quiet — even the stars seem to pause. Golden light from the screen illuminates their faces. The moment is sacred, intimate, timeless. Fantasy art, painterly, emotionally rich. 16:9." },
      { id: "13-screen-softening", name: "Screen Softening", act: "act-3", priority: "important", text: "A living crystal screen showing a close-up of a human man's face (Latino, short dark hair, slight beard). But now his expression is completely different from before — soft, relaxed, at peace. Eyes slightly unfocused, a gentle half-smile. The writing has changed him. The crystal screen itself seems to glow warmer in response. Golden particles drift from the screen into the cosmic living room. The image suggests surrender, presence, arrival. 16:9." },
      { id: "14-bioluminescent-details", name: "Bioluminescent Details", act: "act-3", priority: "optional", text: "Macro close-up of bioluminescent plants and living crystals in a cosmic environment. Golden spiral patterns grow like natural fractals on crystalline surfaces. Tiny glowing organisms float like underwater plankton but in space. The colors are deep purples, electric blues, and warm ambers. Dew-like droplets of light cling to petal-shaped crystal formations. Everything breathes with a slow, organic rhythm. Ultra-detailed, macro photography style meets fantasy art. 16:9." },
      { id: "15-golden-spirals", name: "Golden Spirals Emanating", act: "act-3", priority: "optional", text: "Abstract art of golden spiral patterns emanating outward from a central point. The spirals are mathematical, precise, but organic — like nautilus shells made of light. They radiate through deep purple and midnight blue space. As the spirals extend outward, they begin to form recognizable shapes — a face, hands typing, a pen on paper. The outer edges dissolve into reality. Fibonacci sequences visible in the geometry. Luminous, transcendent, bridging worlds. 16:9." },
      { id: "16-meditating-anky", name: "Meditating Anky — End Card", act: "act-5", priority: "critical", text: "A single small blue goblin-like creature with large round expressive eyes (closed in meditation), a bulbous nose, and a distinctive purple brain-cap covered in intricate golden spiral patterns. The creature sits in lotus position on pure black background. Golden spiral patterns emanate outward from the brain-cap, creating concentric rings of sacred geometry. The creature's body glows faintly with inner light — deep blue skin luminescent. Complete stillness. Complete peace. The golden spirals extend to the edges of the frame. Breathing light pulses softly. Simple, powerful, iconic. 16:9." },
      { id: "17-anky-logo", name: "ANKY Logo Treatment", act: "act-5", priority: "important", text: "The word \"ANKY\" rendered in golden light against pure black. The letters are formed from golden spiral patterns — each letter contains visible Fibonacci spirals and sacred geometry. The \"A\" has a small meditating figure silhouette at its peak. The text glows with warm amber light, casting subtle golden reflections below. Below the main text, in much smaller, softer white light: \"learn how to focus\". Minimalist, powerful, logo-quality. 16:9." }
    ]
  };

  // ===== State =====
  var phase = 'prep'; // prep | record | review
  var mediaStream = null;
  var mediaRecorder = null;
  var recordedChunks = [];
  var recordedBlob = null;
  var recordStartTime = 0;
  var timerRaf = null;
  var generatedImages = {}; // prompt_id -> image_url

  // ===== DOM =====
  var phasePrep = document.getElementById('phase-prep');
  var phaseRecord = document.getElementById('phase-record');
  var phaseReview = document.getElementById('phase-review');
  var btnStart = document.getElementById('btn-start-recording');
  var btnStop = document.getElementById('btn-stop');
  var btnUpload = document.getElementById('btn-upload');
  var btnRestart = document.getElementById('btn-restart');
  var countdownOverlay = document.getElementById('countdown-overlay');
  var countdownNumber = document.getElementById('countdown-number');
  var cameraPip = document.getElementById('camera-pip');
  var timerElapsed = document.getElementById('timer-elapsed');
  var timerAct = document.getElementById('timer-act');
  var progressFill = document.getElementById('progress-fill');
  var teleprompterText = document.getElementById('teleprompter-text');
  var reviewVideo = document.getElementById('review-video');
  var uploadStatus = document.getElementById('upload-status');
  var genCount = document.getElementById('gen-count');
  var imageGrid = document.getElementById('image-grid');

  // ===== Build Image Grid =====
  function buildImageGrid() {
    var html = '';
    SCRIPT.prompts.forEach(function(p) {
      html += '<div class="studio-img-card" id="img-' + p.id + '">'
        + '<div class="studio-img-header">'
        + '<span class="studio-img-id">#' + p.id.split('-')[0] + '</span>'
        + '<span class="studio-img-name">' + p.name + '</span>'
        + '<span class="studio-img-badge ' + p.priority + '">' + p.priority + '</span>'
        + '</div>'
        + '<div class="studio-img-preview" id="preview-' + p.id + '"></div>'
        + '<button class="studio-gen-btn" data-prompt-id="' + p.id + '" data-prompt-text="' + escapeAttr(p.text) + '">generate</button>'
        + '</div>';
    });
    imageGrid.innerHTML = html;
  }

  function escapeAttr(s) {
    return s.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;');
  }

  function updateGenCount() {
    var count = Object.keys(generatedImages).length;
    genCount.textContent = count + '/17';
  }

  // ===== Payment + Image Generation =====
  var FRAME_COST_USD = 0.10;
  var treasuryAddress = '';

  // Fetch treasury address on load
  fetch('/api/treasury').then(function(r) { return r.json(); }).then(function(d) {
    treasuryAddress = d.address || '';
  });

  function generateFrame(promptId, promptText, txHash, btn) {
    var headers = { 'Content-Type': 'application/json' };
    if (txHash) headers['payment-signature'] = txHash;

    return fetch('/api/v1/generate/video-frame', {
      method: 'POST',
      headers: headers,
      body: JSON.stringify({ prompt_id: promptId, prompt_text: promptText })
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.image_url) {
        generatedImages[promptId] = data.image_url;
        var preview = document.getElementById('preview-' + promptId);
        preview.innerHTML = '<img src="' + data.image_url + '" alt="' + promptId + '">';
        if (btn) { btn.textContent = 'regenerate'; btn.disabled = false; }
        updateGenCount();
        return true;
      } else {
        if (btn) { btn.textContent = 'failed — retry'; btn.disabled = false; }
        return false;
      }
    })
    .catch(function() {
      if (btn) { btn.textContent = 'failed — retry'; btn.disabled = false; }
      return false;
    });
  }

  // Single image generate (click on individual button)
  imageGrid.addEventListener('click', function(e) {
    var btn = e.target.closest('.studio-gen-btn');
    if (!btn || btn.disabled) return;

    var promptId = btn.dataset.promptId;
    var promptText = btn.dataset.promptText;

    if (!window.ankyWallet.isLoggedIn()) {
      alert('Connect your wallet first to pay for image generation.');
      window.ankyWallet.connect();
      return;
    }

    btn.disabled = true;
    btn.textContent = 'paying...';

    window.ankyWallet.sendUSDC(treasuryAddress, FRAME_COST_USD)
    .then(function(txHash) {
      btn.textContent = 'generating...';
      return generateFrame(promptId, promptText, txHash, btn);
    })
    .catch(function(err) {
      btn.textContent = 'generate';
      btn.disabled = false;
      if (err.message !== 'wallet not connected') {
        alert('Payment failed: ' + err.message);
      }
    });
  });

  // Generate All button
  var btnGenerateAll = document.getElementById('btn-generate-all');
  btnGenerateAll.addEventListener('click', function() {
    // Find prompts that haven't been generated yet
    var remaining = SCRIPT.prompts.filter(function(p) {
      return !generatedImages[p.id];
    });

    if (remaining.length === 0) {
      alert('All images already generated!');
      return;
    }

    if (!window.ankyWallet.isLoggedIn()) {
      alert('Connect your wallet first to pay for image generation.');
      window.ankyWallet.connect();
      return;
    }

    var totalCost = remaining.length * FRAME_COST_USD;
    var msg = 'Generate ' + remaining.length + ' images for $' + totalCost.toFixed(2) + ' USDC?';
    if (!confirm(msg)) return;

    btnGenerateAll.disabled = true;
    btnGenerateAll.textContent = 'PAYING...';

    window.ankyWallet.sendUSDC(treasuryAddress, totalCost)
    .then(function(txHash) {
      btnGenerateAll.textContent = 'GENERATING 0/' + remaining.length + '...';

      // Disable all individual generate buttons
      imageGrid.querySelectorAll('.studio-gen-btn').forEach(function(b) { b.disabled = true; });

      // Generate sequentially to avoid overwhelming the server
      var completed = 0;
      function generateNext(index) {
        if (index >= remaining.length) {
          btnGenerateAll.textContent = 'ALL GENERATED';
          btnGenerateAll.disabled = false;
          // Re-enable individual buttons
          imageGrid.querySelectorAll('.studio-gen-btn').forEach(function(b) { b.disabled = false; b.textContent = 'regenerate'; });
          return;
        }
        var p = remaining[index];
        var btn = imageGrid.querySelector('[data-prompt-id="' + p.id + '"]');
        if (btn) { btn.textContent = 'generating...'; }

        generateFrame(p.id, p.text, txHash, btn).then(function() {
          completed++;
          btnGenerateAll.textContent = 'GENERATING ' + completed + '/' + remaining.length + '...';
          generateNext(index + 1);
        });
      }
      generateNext(0);
    })
    .catch(function(err) {
      btnGenerateAll.disabled = false;
      btnGenerateAll.textContent = 'GENERATE ALL IMAGES';
      if (err.message !== 'wallet not connected') {
        alert('Payment failed: ' + err.message);
      }
    });
  });

  // ===== Phase Transitions =====
  function showPhase(p) {
    phase = p;
    phasePrep.style.display = p === 'prep' ? '' : 'none';
    phaseRecord.style.display = p === 'record' ? '' : 'none';
    phaseReview.style.display = p === 'review' ? '' : 'none';

    if (p === 'record') {
      document.body.classList.add('studio-recording-active');
    } else {
      document.body.classList.remove('studio-recording-active');
    }
  }

  // ===== Build Teleprompter Text =====
  function buildTeleprompterText() {
    var html = '';
    SCRIPT.acts.forEach(function(act) {
      html += '<div class="teleprompter-act" data-act="' + act.id + '">';
      html += '<div class="teleprompter-act-label">' + act.title + '</div>';
      act.lines.forEach(function(line) {
        html += '<p>' + line + '</p>';
      });
      html += '</div>';
    });
    teleprompterText.innerHTML = html;
  }

  // ===== Recording Flow =====
  btnStart.addEventListener('click', function() {
    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: true })
    .then(function(stream) {
      mediaStream = stream;
      cameraPip.srcObject = stream;
      startCountdown();
    })
    .catch(function(err) {
      alert('Camera access required: ' + err.message);
    });
  });

  function startCountdown() {
    showPhase('record');
    countdownOverlay.style.display = 'flex';
    var count = 3;
    countdownNumber.textContent = count;

    var interval = setInterval(function() {
      count--;
      if (count > 0) {
        countdownNumber.textContent = count;
      } else {
        clearInterval(interval);
        countdownOverlay.style.display = 'none';
        startRecording();
      }
    }, 1000);
  }

  function startRecording() {
    recordedChunks = [];
    buildTeleprompterText();

    // Start teleprompter scroll
    var teleprompter = document.getElementById('teleprompter');
    var textEl = teleprompterText;
    // Reset position
    textEl.style.transform = 'translateY(50vh)';

    mediaRecorder = new MediaRecorder(mediaStream, {
      mimeType: MediaRecorder.isTypeSupported('video/webm;codecs=vp9,opus')
        ? 'video/webm;codecs=vp9,opus'
        : 'video/webm'
    });

    mediaRecorder.ondataavailable = function(e) {
      if (e.data.size > 0) recordedChunks.push(e.data);
    };

    mediaRecorder.onstop = function() {
      recordedBlob = new Blob(recordedChunks, { type: 'video/webm' });
      reviewVideo.src = URL.createObjectURL(recordedBlob);
      showPhase('review');
    };

    mediaRecorder.start(1000); // chunk every second
    recordStartTime = performance.now();

    // Start timer loop
    timerRaf = requestAnimationFrame(updateTimer);
  }

  function updateTimer() {
    var elapsed = (performance.now() - recordStartTime) / 1000;
    var min = Math.floor(elapsed / 60);
    var sec = Math.floor(elapsed % 60);
    timerElapsed.textContent = min + ':' + (sec < 10 ? '0' : '') + sec;

    // Update progress bar
    var pct = Math.min(100, (elapsed / SCRIPT.target_duration) * 100);
    progressFill.style.width = pct + '%';

    // Update current act
    var currentAct = SCRIPT.acts[0];
    for (var i = 0; i < SCRIPT.acts.length; i++) {
      if (elapsed >= SCRIPT.acts[i].start) currentAct = SCRIPT.acts[i];
    }
    timerAct.textContent = 'Act ' + currentAct.id.split('-')[1] + ': ' + currentAct.title;

    // Teleprompter scroll — translate text upward over target_duration
    var scrollPct = elapsed / SCRIPT.target_duration;
    var totalHeight = teleprompterText.scrollHeight;
    var viewHeight = document.getElementById('teleprompter').offsetHeight;
    var startOffset = viewHeight * 0.5;
    var endOffset = -totalHeight;
    var currentOffset = startOffset + (endOffset - startOffset) * scrollPct;
    teleprompterText.style.transform = 'translateY(' + currentOffset + 'px)';

    timerRaf = requestAnimationFrame(updateTimer);
  }

  btnStop.addEventListener('click', function() {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
      mediaRecorder.stop();
    }
    if (timerRaf) cancelAnimationFrame(timerRaf);
    if (mediaStream) {
      mediaStream.getTracks().forEach(function(t) { t.stop(); });
    }
  });

  // ===== Review Phase =====
  btnRestart.addEventListener('click', function() {
    if (recordedBlob) {
      URL.revokeObjectURL(reviewVideo.src);
      recordedBlob = null;
    }
    uploadStatus.style.display = 'none';
    showPhase('prep');
  });

  btnUpload.addEventListener('click', function() {
    if (!recordedBlob) return;
    btnUpload.disabled = true;
    btnUpload.textContent = 'UPLOADING...';
    uploadStatus.style.display = 'block';
    uploadStatus.textContent = 'Uploading video...';
    uploadStatus.className = 'studio-upload-status';

    var duration = (performance.now() - recordStartTime) / 1000;
    var formData = new FormData();
    formData.append('video', recordedBlob, 'studio-recording.webm');
    formData.append('metadata', JSON.stringify({
      title: 'ANKY — Learn How To Focus',
      duration_seconds: duration,
      scenes: SCRIPT.acts.map(function(a) {
        return { id: a.id, title: a.title, start: a.start, end: a.end };
      })
    }));

    fetch('/api/v1/studio/upload', {
      method: 'POST',
      body: formData
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.video_id) {
        uploadStatus.textContent = 'Uploaded! Video ID: ' + data.video_id + ' (' + data.size_mb + ' MB)';
        uploadStatus.classList.add('success');
        btnUpload.textContent = 'UPLOADED';
      } else {
        throw new Error(data.error || 'upload failed');
      }
    })
    .catch(function(err) {
      uploadStatus.textContent = 'Upload failed: ' + err.message;
      uploadStatus.classList.add('error');
      btnUpload.disabled = false;
      btnUpload.textContent = 'RETRY UPLOAD';
    });
  });

  // ===== Init =====
  buildImageGrid();
  updateGenCount();
  showPhase('prep');
})();
</script>
{% endblock %}
