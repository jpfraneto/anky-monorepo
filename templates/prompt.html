{% extends "base.html" %}

{% block title %}{{ prompt_text | truncate(length=60) }} — anky{% endblock %}

{% block head %}
<meta property="og:title" content="{{ prompt_text | truncate(length=100) }}">
<meta property="og:description" content="write for 8 minutes without stopping. what emerges is a mirror.">
<meta property="og:image" content="{{ image_url }}">
<meta property="og:type" content="website">
<meta property="og:url" content="https://anky.app/prompt/{{ id }}">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@jpfraneto">
<meta name="twitter:title" content="{{ prompt_text | truncate(length=100) }}">
<meta name="twitter:description" content="write for 8 minutes without stopping. what emerges is a mirror.">
<meta name="twitter:image" content="{{ image_url }}">
<meta name="twitter:image:alt" content="{{ prompt_text | truncate(length=100) }}">
{% endblock %}

{% block content %}
<!-- Challenge overlay -->
<div class="challenge-overlay" id="challenge-overlay">
  <div class="challenge-inner">
    <p class="challenge-creator">@{{ creator_username }} challenged you</p>
    <p class="challenge-prompt">{{ prompt_text }}</p>
    <p class="challenge-desc">write for 8 minutes without stopping.<br>no backspace. no editing. just write.</p>
    <button class="challenge-begin" id="challenge-begin">tap to begin</button>
  </div>
</div>

<div class="writing-container">
  <div class="writing-main">
    <div id="life-bar"></div>
    <div class="prompt-display at-top" id="prompt-display">{{ prompt_text }}</div>
    <textarea
      id="prompt-writing-area"
      autocomplete="off"
      autocorrect="off"
      autocapitalize="off"
      spellcheck="false"
      data-gramm="false"
      data-gramm_editor="false"
      data-enable-grammarly="false"
      style="font-family: {{ user_font_family }}; font-size: {{ user_font_size }}px;"
    ></textarea>
    <div id="chat-container" class="chat-container"></div>
  </div>
  <div class="session-bar" id="session-bar">
    <div class="session-progress" id="session-progress"></div>
    <div class="session-bar-inner">
      <div class="session-comments" id="session-comments"></div>
      <div class="session-stats">
        <span id="prompt-stat-words">0 words</span>
        <span id="prompt-stat-time" class="stat-dim"></span>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global — needed by share card onclick handlers
var lastStreamedTitle = '';
var lastStreamedReflection = '';

(function() {
  // Add prompt-page body class
  document.body.classList.add('prompt-page');
  {% if user_theme == "light" %}document.body.classList.add('theme-light');{% endif %}

  var textarea = document.getElementById('prompt-writing-area');
  var promptDisplay = document.getElementById('prompt-display');
  var lifeBar = document.getElementById('life-bar');
  var chatContainer = document.getElementById('chat-container');
  var statWords = document.getElementById('prompt-stat-words');
  var statTime = document.getElementById('prompt-stat-time');
  var sessionProgress = document.getElementById('session-progress');
  var sessionComments = document.getElementById('session-comments');
  var challengeOverlay = document.getElementById('challenge-overlay');
  var challengeBegin = document.getElementById('challenge-begin');

  var sessionActive = false;
  var sessionStartTime = null;
  var lastKeystrokeTime = null;
  var blockedCount = 0;
  var animFrame = null;
  var pageOpenedAt = Date.now();
  var firstKeystrokeAt = null;
  var keystrokeDeltas = [];

  var TOTAL_SECONDS = 480;
  var IDLE_TIMEOUT = {{ user_idle_timeout }} * 1000;
  var CHECKPOINT_INTERVAL = 30000;
  var checkpointTimer = null;
  var sessionId = null;
  var promptId = '{{ id }}';

  var currentAnkyId = null;
  var chatHistory = [];
  var currentWritingText = '';

  // Challenge overlay dismiss
  function dismissChallenge() {
    challengeOverlay.classList.add('fade-out');
    setTimeout(function() {
      challengeOverlay.style.display = 'none';
      textarea.focus();
    }, 400);
  }

  challengeBegin.addEventListener('click', dismissChallenge);
  challengeOverlay.addEventListener('click', function(e) {
    if (e.target === challengeOverlay) dismissChallenge();
  });

  // --- Shared utilities ---

  function escapeHtml(s) {
    var div = document.createElement('div');
    div.textContent = s;
    return div.innerHTML;
  }

  function renderMarkdown(text) {
    return text
      .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
      .replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>')
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.+?)\*/g, '<em>$1</em>')
      .replace(/^### (.+)$/gm, '<h4>$1</h4>')
      .replace(/^## (.+)$/gm, '<h3>$1</h3>')
      .replace(/^# (.+)$/gm, '<h3>$1</h3>')
      .replace(/\n\n+/g, '</p><p>')
      .replace(/\n/g, '<br>');
  }

  function addChatBubble(role, html) {
    var bubble = document.createElement('div');
    bubble.className = 'chat-bubble ' + role;
    bubble.innerHTML = html;
    chatContainer.appendChild(bubble);
    chatContainer.scrollTop = chatContainer.scrollHeight;
    return bubble;
  }

  function showCheckpoint(msg) {
    sessionComments.textContent = msg;
    sessionComments.classList.add('visible');
    setTimeout(function() { sessionComments.classList.remove('visible'); }, 4000);
  }

  function saveCheckpoint() {
    if (!sessionActive || !textarea.value) return;
    var elapsed = (Date.now() - sessionStartTime) / 1000;
    if (!sessionId) sessionId = 'ses_' + Date.now().toString(36);
    fetch('/api/checkpoint', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ session_id: sessionId, text: textarea.value, elapsed: elapsed }),
    }).catch(function() {});
    showCheckpoint('checkpoint saved');
  }

  // --- Animation loop ---

  function animate() {
    if (!sessionActive) return;
    var elapsed = (Date.now() - sessionStartTime) / 1000;

    var mins = Math.floor(elapsed / 60);
    var secs = Math.floor(elapsed % 60);
    statTime.textContent = mins + ':' + (secs < 10 ? '0' : '') + secs;
    if (elapsed >= TOTAL_SECONDS) {
      statTime.className = 'stat-time-done';
    }

    var progressPct = Math.min((elapsed / TOTAL_SECONDS) * 100, 100);
    sessionProgress.style.width = progressPct + '%';
    if (progressPct >= 100) {
      sessionProgress.classList.add('complete');
    }

    // Life bar — only show when > 3 seconds since last keystroke
    var sinceLastKey = Date.now() - lastKeystrokeTime;
    if (sinceLastKey < 3000) {
      lifeBar.style.opacity = '0';
    } else {
      lifeBar.style.opacity = '1';
      var ratio = 1 - sinceLastKey / IDLE_TIMEOUT;
      if (ratio < 0) ratio = 0;
      lifeBar.style.width = (ratio * 100) + '%';
    }

    if (sinceLastKey >= IDLE_TIMEOUT) {
      endSession();
      return;
    }
    animFrame = requestAnimationFrame(animate);
  }

  function startSession() {
    sessionActive = true;
    sessionStartTime = Date.now();
    lastKeystrokeTime = Date.now();
    blockedCount = 0;
    sessionId = 'ses_' + Date.now().toString(36);

    // Immersive mode
    document.body.classList.add('writing-active');
    window.scrollTo({ top: 0 });

    animate();
    checkpointTimer = setInterval(saveCheckpoint, CHECKPOINT_INTERVAL);
  }

  // --- Chat flow functions (ported from home.html) ---

  function submitNewWriting(text) {
    var inputArea = document.getElementById('chat-input-area');
    if (inputArea) inputArea.remove();

    currentWritingText = text;

    if (text.length > 500) {
      var preview = escapeHtml(text.substring(0, 300)) + '...';
      var full = escapeHtml(text);
      addChatBubble('user',
        '<div class="writing-collapsed">' +
          '<span class="writing-preview-text">' + preview + '</span>' +
          '<button class="writing-toggle" onclick="var p=this.parentNode;var s=p.querySelector(\'.writing-preview-text\');var f=p.querySelector(\'.writing-full-text\');if(f.style.display===\'none\'){f.style.display=\'inline\';s.style.display=\'none\';this.textContent=\'collapse\';}else{f.style.display=\'none\';s.style.display=\'inline\';this.textContent=\'show full writing\';}">show full writing</button>' +
          '<span class="writing-full-text" style="display:none;">' + full + '</span>' +
        '</div>');
    } else {
      addChatBubble('user', escapeHtml(text));
    }

    addChatBubble('anky', '<span class="processing">processing...</span>').id = 'anky-bubble';

    fetch('/write', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text: text, duration: 0 }),
    })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        var ankyBubble = document.getElementById('anky-bubble');
        if (data.error) {
          ankyBubble.innerHTML = '<span class="error">' + escapeHtml(data.error) + '</span>';
          setTimeout(function() { showQuickChatInput(); }, 500);
          return;
        }
        if (data.is_anky && data.anky_id) {
          currentAnkyId = data.anky_id;
          ankyBubble.innerHTML = '<span class="processing">anky is reading your writing...</span>';
          addChatBubble('anky', '<div id="anky-inline-image" class="anky-image-skeleton"><div class="skeleton-pulse"></div></div>');
          streamAnkyReflection(data.anky_id);
        } else {
          ankyBubble.innerHTML = '<span class="anky-response-text">' + renderMarkdown(data.response) + '</span>';
          chatContainer.scrollTop = chatContainer.scrollHeight;
          setTimeout(function() { showQuickChatInput(); }, 1500);
        }
      })
      .catch(function() {
        var ankyBubble = document.getElementById('anky-bubble');
        ankyBubble.innerHTML = '<span class="error">something went wrong. try again?</span>';
        setTimeout(function() { showQuickChatInput(); }, 500);
      });
  }

  function createChatInputArea(sendMessageFn) {
    if (document.getElementById('chat-input-area')) return;
    var inputArea = document.createElement('div');
    inputArea.id = 'chat-input-area';
    inputArea.className = 'chat-input-area';
    inputArea.innerHTML =
      '<textarea id="chat-input" class="chat-input" placeholder="continue writing..." rows="1" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" data-gramm="false" data-gramm_editor="false" data-enable-grammarly="false"></textarea>' +
      '<button id="chat-send" class="chat-send-btn" disabled>send</button>';
    var writingMain = document.querySelector('.writing-main');
    writingMain.appendChild(inputArea);

    var input = document.getElementById('chat-input');
    var sendBtn = document.getElementById('chat-send');
    var chatIdleTimer = null;

    // Blocked keys — same rules as main writing area
    input.addEventListener('keydown', function(e) {
      var blocked = ['Backspace', 'Delete', 'Enter', 'Tab',
        'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Home', 'End'];
      if (blocked.indexOf(e.key) !== -1) {
        e.preventDefault();
        return;
      }
      if ((e.ctrlKey || e.metaKey) && 'axzy'.indexOf(e.key.toLowerCase()) !== -1) {
        e.preventDefault();
      }
    });

    function blockEvent(e) { e.preventDefault(); }
    input.addEventListener('paste', blockEvent);
    input.addEventListener('cut', blockEvent);
    input.addEventListener('drop', blockEvent);

    input.addEventListener('input', function() {
      input.selectionStart = input.selectionEnd = input.value.length;
      input.style.height = 'auto';
      input.style.height = Math.min(input.scrollHeight, 200) + 'px';
      sendBtn.disabled = !input.value.trim();
      if (chatIdleTimer) clearTimeout(chatIdleTimer);
      chatIdleTimer = setTimeout(function() {
        var text = input.value.trim();
        if (text) submitNewWriting(text);
      }, IDLE_TIMEOUT);
    });

    sendBtn.onclick = function() {
      if (chatIdleTimer) clearTimeout(chatIdleTimer);
      sendMessageFn(input, sendBtn);
    };

    input.focus();
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }

  function showChatInput() {
    createChatInputArea(function(input, sendBtn) {
      var msg = input.value.trim();
      if (!msg || !currentAnkyId) return;
      input.value = '';
      input.style.height = 'auto';
      sendBtn.disabled = true;

      addChatBubble('user', escapeHtml(msg));
      var thinking = addChatBubble('anky', '<span class="processing">thinking...</span>');

      fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          anky_id: currentAnkyId,
          message: msg,
          history: chatHistory,
        }),
      })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          chatHistory.push({ role: 'user', content: msg });
          chatHistory.push({ role: 'assistant', content: data.response });
          thinking.innerHTML = '<span class="anky-response-text">' + renderMarkdown(data.response) + '</span>';
          sendBtn.disabled = !input.value.trim();
          input.focus();
          chatContainer.scrollTop = chatContainer.scrollHeight;
        })
        .catch(function() {
          thinking.innerHTML = '<span class="error">something went wrong. try again?</span>';
          sendBtn.disabled = !input.value.trim();
        });
    });
  }

  function showQuickChatInput() {
    createChatInputArea(function(input, sendBtn) {
      var msg = input.value.trim();
      if (!msg) return;
      input.value = '';
      input.style.height = 'auto';
      sendBtn.disabled = true;

      addChatBubble('user', escapeHtml(msg));
      var thinking = addChatBubble('anky', '<span class="processing">thinking...</span>');

      fetch('/api/chat-quick', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          writing: currentWritingText,
          message: msg,
          history: chatHistory,
        }),
      })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          chatHistory.push({ role: 'user', content: msg });
          chatHistory.push({ role: 'assistant', content: data.response });
          thinking.innerHTML = '<span class="anky-response-text">' + renderMarkdown(data.response) + '</span>';
          sendBtn.disabled = !input.value.trim();
          input.focus();
          chatContainer.scrollTop = chatContainer.scrollHeight;
        })
        .catch(function() {
          thinking.innerHTML = '<span class="error">something went wrong. try again?</span>';
          sendBtn.disabled = !input.value.trim();
        });
    });
  }

  function streamAnkyReflection(ankyId) {
    var ankyBubble = document.getElementById('anky-bubble');
    var fullText = '';
    var titleParsed = false;
    var titleText = '';
    var renderPending = false;

    function renderCurrentText() {
      if (!titleParsed && fullText.indexOf('\n') !== -1) {
        titleText = fullText.substring(0, fullText.indexOf('\n')).trim();
        titleParsed = true;
        lastStreamedTitle = titleText;
      }
      lastStreamedReflection = fullText;
      if (titleParsed) {
        var rest = fullText.substring(fullText.indexOf('\n') + 1).trim();
        ankyBubble.innerHTML =
          '<div class="anky-chat-title">' + escapeHtml(titleText) + '</div>' +
          '<span class="anky-response-text">' + renderMarkdown(rest) + '</span>';
      } else if (fullText) {
        ankyBubble.innerHTML =
          '<span class="anky-response-text">' + escapeHtml(fullText) + '</span>';
      }
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    var source = new EventSource('/api/stream-reflection/' + ankyId);

    source.onmessage = function(e) {
      fullText += e.data;
      if (!renderPending) {
        renderPending = true;
        requestAnimationFrame(function() {
          renderCurrentText();
          renderPending = false;
        });
      }
    };

    source.addEventListener('done', function() {
      source.close();
      renderCurrentText();
      pollAnkyImage(ankyId);
    });

    source.onerror = function() {
      source.close();
      if (!fullText) {
        pollAnkyReflection(ankyId);
      } else {
        renderCurrentText();
        pollAnkyImage(ankyId);
      }
    };
  }

  function pollAnkyImage(ankyId) {
    var pollCount = 0;
    var interval = setInterval(function() {
      pollCount++;
      fetch('/api/v1/anky/' + ankyId)
        .then(function(r) { return r.json(); })
        .then(function(data) {
          var imgEl = document.getElementById('anky-inline-image');
          if (data.status === 'complete' && data.image_url) {
            clearInterval(interval);
            var shareHtml = '<div class="anky-share-link" onclick="window.ankyShareCard.open({imageUrl:this.parentNode.querySelector(\'img\').src,title:lastStreamedTitle,reflection:lastStreamedReflection,ankyId:\'' + ankyId + '\'})"><span>share</span></div>';
            if (imgEl) {
              imgEl.innerHTML = '<img src="' + data.image_url + '" alt="your anky" class="anky-chat-img" />' + shareHtml;
            } else {
              addChatBubble('anky', '<img src="' + data.image_url + '" alt="your anky" class="anky-chat-img" />' + shareHtml);
            }
            showChatInput();
            window.ankyShareCard.open({
              imageUrl: data.image_url,
              title: lastStreamedTitle || data.title || '',
              reflection: lastStreamedReflection || data.reflection || '',
              ankyId: ankyId
            });
          } else if (data.status === 'failed') {
            clearInterval(interval);
            if (imgEl) imgEl.innerHTML = '<span class="error">image generation failed. it will be retried.</span>';
            showChatInput();
          }
          if (pollCount > 100) clearInterval(interval);
        })
        .catch(function() {});
    }, 3000);
  }

  function pollAnkyReflection(ankyId) {
    var ankyBubble = document.getElementById('anky-bubble');
    var pollCount = 0;
    var reflectionShown = false;
    var interval = setInterval(function() {
      pollCount++;
      fetch('/api/v1/anky/' + ankyId)
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.reflection && !reflectionShown) {
            reflectionShown = true;
            lastStreamedTitle = data.title || '';
            lastStreamedReflection = data.reflection || '';
            ankyBubble.innerHTML = '<span class="anky-response-text">' + renderMarkdown(data.reflection) + '</span>';
            if (data.title) {
              ankyBubble.innerHTML = '<div class="anky-chat-title">' + escapeHtml(data.title) + '</div>' + ankyBubble.innerHTML;
            }
            chatContainer.scrollTop = chatContainer.scrollHeight;
          }
          var imgEl = document.getElementById('anky-inline-image');
          if (data.status === 'complete' && data.image_url) {
            clearInterval(interval);
            var shareHtml = '<div class="anky-share-link" onclick="window.ankyShareCard.open({imageUrl:this.parentNode.querySelector(\'img\').src,title:lastStreamedTitle,reflection:lastStreamedReflection,ankyId:\'' + ankyId + '\'})"><span>share</span></div>';
            if (imgEl) {
              imgEl.innerHTML = '<img src="' + data.image_url + '" alt="your anky" class="anky-chat-img" />' + shareHtml;
            } else {
              addChatBubble('anky', '<img src="' + data.image_url + '" alt="your anky" class="anky-chat-img" />' + shareHtml);
            }
            showChatInput();
            window.ankyShareCard.open({
              imageUrl: data.image_url,
              title: lastStreamedTitle || data.title || '',
              reflection: lastStreamedReflection || data.reflection || '',
              ankyId: ankyId
            });
          } else if (data.status === 'failed') {
            clearInterval(interval);
            if (imgEl) imgEl.innerHTML = '<span class="error">image generation failed. it will be retried.</span>';
            showChatInput();
          }
          if (pollCount > 100) clearInterval(interval);
        })
        .catch(function() {});
    }, 3000);
  }

  // --- End session: full pipeline ---

  function endSession() {
    if (!sessionActive) return;
    sessionActive = false;
    if (animFrame) cancelAnimationFrame(animFrame);
    if (checkpointTimer) { clearInterval(checkpointTimer); checkpointTimer = null; }
    sessionComments.classList.remove('visible');
    lifeBar.style.width = '0%';
    lifeBar.style.opacity = '0';

    var duration = (Date.now() - sessionStartTime) / 1000;
    var text = textarea.value;
    currentWritingText = text;
    chatHistory = [];
    currentAnkyId = null;

    // Reset session bar
    sessionProgress.style.width = '0%';
    sessionProgress.classList.remove('complete');

    // Fire-and-forget: save prompt-specific session data
    fetch('/api/v1/prompt/' + promptId + '/write', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        content: text,
        keystroke_deltas: JSON.stringify(keystrokeDeltas),
        page_opened_at: new Date(pageOpenedAt).toISOString(),
        first_keystroke_at: firstKeystrokeAt ? new Date(firstKeystrokeAt).toISOString() : null,
        duration_seconds: duration,
      }),
    }).catch(function() {});

    // Switch to chat mode — show navbar, hide prompt display
    document.body.classList.remove('writing-active');
    document.body.classList.add('chat-active');

    // Hide writing UI, show chat
    textarea.style.display = 'none';
    promptDisplay.style.display = 'none';
    chatContainer.style.display = 'flex';
    chatContainer.innerHTML = '';

    // User bubble — collapsible if long
    if (text.length > 500) {
      var preview = escapeHtml(text.substring(0, 300)) + '...';
      var full = escapeHtml(text);
      addChatBubble('user',
        '<div class="writing-collapsed">' +
          '<span class="writing-preview-text">' + preview + '</span>' +
          '<button class="writing-toggle" onclick="var p=this.parentNode;var s=p.querySelector(\'.writing-preview-text\');var f=p.querySelector(\'.writing-full-text\');if(f.style.display===\'none\'){f.style.display=\'inline\';s.style.display=\'none\';this.textContent=\'collapse\';}else{f.style.display=\'none\';s.style.display=\'inline\';this.textContent=\'show full writing\';}">show full writing</button>' +
          '<span class="writing-full-text" style="display:none;">' + full + '</span>' +
        '</div>'
      );
    } else {
      addChatBubble('user', escapeHtml(text));
    }

    // Anky response bubble
    addChatBubble('anky', '<span class="processing">processing...</span>').id = 'anky-bubble';

    // POST to /write — triggers the full anky pipeline
    fetch('/write', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text: text, duration: duration }),
    })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        var ankyBubble = document.getElementById('anky-bubble');
        if (data.error) {
          ankyBubble.innerHTML = '<span class="error">' + escapeHtml(data.error) + '</span>';
          setTimeout(function() { showQuickChatInput(); }, 500);
          return;
        }

        if (data.is_anky && data.anky_id) {
          currentAnkyId = data.anky_id;
          ankyBubble.innerHTML = '<span class="processing">anky is reading your writing...</span>';
          addChatBubble('anky', '<div id="anky-inline-image" class="anky-image-skeleton"><div class="skeleton-pulse"></div></div>');
          streamAnkyReflection(data.anky_id);
        } else {
          ankyBubble.innerHTML = '<span class="anky-response-text">' + renderMarkdown(data.response) + '</span>';
          chatContainer.scrollTop = chatContainer.scrollHeight;
          setTimeout(function() { showQuickChatInput(); }, 1500);
        }
      })
      .catch(function() {
        var ankyBubble = document.getElementById('anky-bubble');
        ankyBubble.innerHTML = '<span class="error">something went wrong. try again?</span>';
        setTimeout(function() { showQuickChatInput(); }, 500);
      });
  }

  // --- Input handling ---

  textarea.addEventListener('input', function() {
    textarea.selectionStart = textarea.selectionEnd = textarea.value.length;
    var now = Date.now();
    keystrokeDeltas.push(now - pageOpenedAt);

    if (!sessionActive) {
      firstKeystrokeAt = now;
      startSession();
    } else {
      lastKeystrokeTime = now;
    }

    var words = textarea.value.split(/\s+/).filter(function(w) { return w.length > 0; }).length;
    statWords.textContent = words + (words === 1 ? ' word' : ' words');
  });

  // Blocked keys
  textarea.addEventListener('keydown', function(e) {
    var blocked = ['Backspace', 'Delete', 'Enter', 'Tab',
      'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Home', 'End'];
    if (blocked.indexOf(e.key) !== -1) {
      e.preventDefault();
      blockedCount++;
      return;
    }
    if ((e.ctrlKey || e.metaKey) && 'axzy'.indexOf(e.key.toLowerCase()) !== -1) {
      e.preventDefault();
      blockedCount++;
    }
  });

  function blockAndCount(e) { e.preventDefault(); blockedCount++; }
  textarea.addEventListener('paste', blockAndCount);
  textarea.addEventListener('cut', blockAndCount);
  textarea.addEventListener('drop', blockAndCount);

  // Keep focus on textarea (only when overlay is gone and not in chat mode)
  document.addEventListener('click', function(e) {
    if (challengeOverlay.style.display === 'none' &&
        textarea.style.display !== 'none' &&
        !chatContainer.contains(e.target)) {
      textarea.focus();
    }
  });

  // Mobile viewport height
  function updateVH() {
    if (window.visualViewport) {
      document.documentElement.style.setProperty('--vh', window.visualViewport.height + 'px');
    }
  }
  if (window.visualViewport) {
    window.visualViewport.addEventListener('resize', updateVH);
    window.visualViewport.addEventListener('scroll', updateVH);
    updateVH();
  }
})();
</script>
{% endblock %}
