{% extends "base.html" %}

{% block title %}anky - gallery{% endblock %}

{% block content %}
<div class="page-header">
  <h2>gallery</h2>
  <p class="subtitle">ankys born from consciousness streams</p>
  <div class="gallery-filters">
    <button class="filter-btn active" data-filter="all">all</button>
    <button class="filter-btn" data-filter="written">written</button>
    <button class="filter-btn" data-filter="generated">generated</button>
  </div>
</div>

<div class="gallery-grid">
  {% for anky in ankys %}
  <div class="gallery-item {% if anky.status != 'complete' %}generating{% endif %}" data-origin="{{ anky.origin }}" tabindex="0">
    <a href="/anky/{{ anky.id }}">
      {% if anky.image_path and anky.status == 'complete' %}
      <img src="/data/images/{{ anky.image_path }}" alt="{{ anky.title }}" loading="lazy">
      {% else %}
      <div class="placeholder">
        <div class="processing">generating...</div>
      </div>
      {% endif %}
      <div class="gallery-caption">
        {% if anky.origin == 'generated' %}
        <span class="gallery-badge generated">generated</span>
        <span class="gallery-prompt">{{ anky.image_prompt | truncate(length=80) }}</span>
        {% else %}
        <span class="gallery-title">{{ anky.title }}</span>
        {% endif %}
        {% if anky.thinker_name %}
        <span class="gallery-thinker">{{ anky.thinker_name }}</span>
        {% endif %}
      </div>
    </a>
  </div>
  {% endfor %}

  {% if ankys | length == 0 %}
  <div class="empty-state">
    <p>no ankys yet. go write for 8 minutes to create your first.</p>
    <a href="/" class="new-session-btn">start writing</a>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
  // Gallery origin filter
  var filterBtns = document.querySelectorAll('.filter-btn');
  var allItems = document.querySelectorAll('.gallery-item');
  filterBtns.forEach(function(btn) {
    btn.addEventListener('click', function() {
      filterBtns.forEach(function(b) { b.classList.remove('active'); });
      btn.classList.add('active');
      var filter = btn.getAttribute('data-filter');
      allItems.forEach(function(item) {
        if (filter === 'all' || item.getAttribute('data-origin') === filter) {
          item.style.display = '';
        } else {
          item.style.display = 'none';
        }
      });
    });
  });

  var grid = document.querySelector('.gallery-grid');
  if (!grid) return;

  function getItems() {
    return Array.from(grid.querySelectorAll('.gallery-item'));
  }

  function getColumns() {
    var items = getItems();
    if (items.length < 2) return 1;
    var firstTop = items[0].getBoundingClientRect().top;
    for (var i = 1; i < items.length; i++) {
      if (items[i].getBoundingClientRect().top !== firstTop) return i;
    }
    return items.length;
  }

  grid.addEventListener('keydown', function(e) {
    var items = getItems();
    var idx = items.indexOf(e.target);
    if (idx === -1) return;

    var cols = getColumns();
    var next = -1;

    if (e.key === 'ArrowRight') {
      next = idx + 1 < items.length ? idx + 1 : 0;
    } else if (e.key === 'ArrowLeft') {
      next = idx - 1 >= 0 ? idx - 1 : items.length - 1;
    } else if (e.key === 'ArrowDown') {
      next = idx + cols < items.length ? idx + cols : idx;
    } else if (e.key === 'ArrowUp') {
      next = idx - cols >= 0 ? idx - cols : idx;
    } else if (e.key === 'Enter') {
      var link = items[idx].querySelector('a');
      if (link) link.click();
      return;
    } else {
      return;
    }

    e.preventDefault();
    items[next].focus();
    items[next].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
  });
})();
</script>
{% endblock %}
