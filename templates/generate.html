{% extends "base.html" %}

{% block title %}generate — anky{% endblock %}

{% block content %}
<div class="container">
  <h1>generate</h1>
  <p class="subtitle">create ankys from a prompt. connect your wallet to pay with USDC on Base.</p>

  <div class="gen-section">
    <label class="gen-label">mode</label>
    <div class="gen-modes" id="gen-modes">
      <button class="mode-btn active" data-mode="prompt" onclick="setMode('prompt')">from prompt</button>
      <button class="mode-btn" data-mode="thinker" onclick="setMode('thinker')">thinker portrait</button>
    </div>
  </div>

  <div class="gen-section" id="prompt-section">
    <label class="gen-label">prompt</label>
    <textarea id="gen-prompt" class="gen-input" rows="3" placeholder="a one-line spark or a full paragraph — whatever you want anky to become"></textarea>
  </div>

  <div class="gen-section" id="thinker-section" style="display:none;">
    <label class="gen-label">thinker</label>
    <input type="text" id="thinker-name" class="gen-input" placeholder="bad bunny" />
    <label class="gen-label" style="margin-top:8px;">moment</label>
    <input type="text" id="thinker-moment" class="gen-input" placeholder="backstage at the super bowl, alone with his thoughts" />
  </div>

  <div class="gen-section">
    <label class="gen-label">how many</label>
    <div class="gen-counts">
      <button class="count-btn active" onclick="setCount(1)">1</button>
      <button class="count-btn" onclick="setCount(8)">8</button>
      <button class="count-btn" onclick="setCount(16)">16</button>
      <button class="count-btn" onclick="setCount(44)">44</button>
      <button class="count-btn" onclick="setCount(88)">88</button>
      <input type="number" id="custom-count" class="gen-input-sm" min="1" max="200" placeholder="#" onchange="setCount(parseInt(this.value)||1)" />
    </div>
  </div>

  <div class="gen-cost" id="gen-cost">
    <span>estimated cost: <strong id="cost-display">$0.25</strong></span>
    <span class="cost-detail" id="cost-detail">$0.25 per generation</span>
  </div>

  <div class="gen-balance" id="gen-balance"></div>

  <button class="gen-btn" id="gen-btn" onclick="generate()">generate</button>

  <div id="gen-status" class="gen-status"></div>

  <!-- Generation progress area (hidden until generation starts) -->
  <div id="gen-progress" class="gen-progress" style="display:none;">
    <div class="gen-skeleton" id="gen-skeleton">
      <div class="skeleton-pulse"></div>
    </div>
    <div class="gen-logs" id="gen-logs"></div>
    <div class="gen-result" id="gen-result" style="display:none;"></div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
  var mode = 'prompt';
  var count = 1;
  var costPerAnky = 0.25;
  var userBalance = null;
  var balanceEl = document.getElementById('gen-balance');

  fetch('/api/cost-estimate')
    .then(function(r) { return r.json(); })
    .then(function(d) { if (d.cost_per_anky) costPerAnky = d.cost_per_anky; updateCost(); })
    .catch(function() {});

  // --- USDC balance check ---
  var USDC_ADDR = '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913';

  async function checkBalance() {
    var wallet = localStorage.getItem('wallet_address');
    if (!wallet || !window.ethereum) {
      balanceEl.innerHTML = '<span class="balance-hint">connect your wallet to pay</span>';
      userBalance = null;
      updateCost();
      return;
    }
    try {
      var addrHex = wallet.slice(2).toLowerCase().padStart(64, '0');
      var data = '0x70a08231' + addrHex;
      var result = await window.ethereum.request({
        method: 'eth_call',
        params: [{ to: USDC_ADDR, data: data }, 'latest'],
      });
      userBalance = parseInt(result, 16) / 1e6;
      balanceEl.innerHTML = '<span class="balance-ok">your USDC balance: <strong>$' +
        userBalance.toFixed(2) + '</strong></span>';
      updateCost();
    } catch(e) {
      balanceEl.innerHTML = '<span class="balance-hint">could not read balance</span>';
      userBalance = null;
    }
  }

  // Check balance on load and when wallet changes
  checkBalance();
  if (window.ankyWallet) {
    var origConnect = window.ankyWallet.connect;
    window.ankyWallet.connect = async function() {
      var result = await origConnect();
      checkBalance();
      return result;
    };
  }
  // Re-check periodically (wallet might change)
  setInterval(checkBalance, 30000);

  window.setMode = function(m) {
    mode = m;
    document.querySelectorAll('.mode-btn').forEach(function(b) {
      b.classList.toggle('active', b.dataset.mode === m);
    });
    document.getElementById('prompt-section').style.display = m === 'prompt' ? '' : 'none';
    document.getElementById('thinker-section').style.display = m === 'thinker' ? '' : 'none';
  };

  window.setCount = function(n) {
    count = Math.max(1, Math.min(200, n));
    document.querySelectorAll('.count-btn').forEach(function(b) {
      b.classList.toggle('active', parseInt(b.textContent) === count);
    });
    updateCost();
  };

  function updateCost() {
    var total = costPerAnky * count;
    document.getElementById('cost-display').textContent = '$' + total.toFixed(2);
    document.getElementById('cost-detail').textContent =
      '$' + costPerAnky.toFixed(2) + ' x ' + count + (count === 1 ? ' generation' : ' generations');

    // Show warning if insufficient balance
    var btn = document.getElementById('gen-btn');
    if (userBalance !== null && userBalance < total) {
      balanceEl.innerHTML = '<span class="balance-low">your USDC balance: <strong>$' +
        userBalance.toFixed(2) + '</strong> — not enough for this generation ($' +
        total.toFixed(2) + '). add USDC on Base to your wallet.</span>';
      btn.disabled = true;
    } else if (userBalance !== null) {
      balanceEl.innerHTML = '<span class="balance-ok">your USDC balance: <strong>$' +
        userBalance.toFixed(2) + '</strong></span>';
      btn.disabled = false;
    } else {
      btn.disabled = false;
    }
  }

  function addLog(msg) {
    var logsEl = document.getElementById('gen-logs');
    var line = document.createElement('div');
    line.className = 'gen-log-line';
    line.textContent = msg;
    logsEl.appendChild(line);
    logsEl.scrollTop = logsEl.scrollHeight;
  }

  function startLogStream() {
    var evtSource = new EventSource('/dashboard/logs');
    evtSource.onmessage = function(e) {
      try {
        var data = JSON.parse(e.data);
        if (data.msg) {
          addLog('[' + (data.tag || '') + '] ' + data.msg);
        }
      } catch(_) {
        addLog(e.data);
      }
    };
    return evtSource;
  }

  function pollAnky(ankyId, evtSource) {
    var interval = setInterval(function() {
      fetch('/api/v1/anky/' + ankyId)
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.status === 'complete') {
            clearInterval(interval);
            if (evtSource) evtSource.close();

            // Hide skeleton, show result
            document.getElementById('gen-skeleton').style.display = 'none';
            var resultEl = document.getElementById('gen-result');
            resultEl.style.display = 'block';

            var imgHtml = '';
            if (data.image_url) {
              imgHtml = '<div class="gen-result-image"><img src="' + data.image_url + '" alt="generated anky" /></div>';
            }
            var promptHtml = data.image_prompt
              ? '<div class="gen-result-prompt">' + data.image_prompt + '</div>'
              : '';

            resultEl.innerHTML = imgHtml + promptHtml +
              '<a href="/anky/' + ankyId + '" class="gen-result-link">view full anky</a>';

            addLog('done!');
          } else if (data.status === 'failed') {
            clearInterval(interval);
            if (evtSource) evtSource.close();
            document.getElementById('gen-skeleton').style.display = 'none';
            addLog('generation failed. it will be retried automatically.');
          }
        })
        .catch(function() {});
    }, 3000);
  }

  window.generate = async function() {
    var btn = document.getElementById('gen-btn');
    var status = document.getElementById('gen-status');
    var wallet = localStorage.getItem('wallet_address');

    var payload;
    var enhancedPrompt = null;
    if (mode === 'thinker') {
      var name = document.getElementById('thinker-name').value.trim();
      var moment = document.getElementById('thinker-moment').value.trim();
      if (!name) { status.innerHTML = '<span class="error">enter a thinker name</span>'; return; }
      payload = { thinker_name: name, moment: moment || 'a quiet moment of deep thought' };
    } else {
      var prompt = document.getElementById('gen-prompt').value.trim();
      if (!prompt) { status.innerHTML = '<span class="error">enter a prompt</span>'; return; }

      // Check prompt before payment
      btn.disabled = true;
      btn.textContent = 'checking prompt...';
      status.innerHTML = '';
      try {
        var checkResp = await fetch('/api/v1/check-prompt', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ writing: prompt }),
        });
        var checkData = await checkResp.json();
        if (checkData.status === 'needs_revision') {
          status.innerHTML = '<span class="error">' + checkData.message + '</span>';
          btn.disabled = false;
          btn.textContent = 'generate';
          return;
        }
        enhancedPrompt = checkData.enhanced_prompt || prompt;
      } catch (e) {
        // If check fails, proceed with raw prompt
        enhancedPrompt = null;
      }
      btn.textContent = 'generate';

      payload = { writing: prompt, enhanced_prompt: enhancedPrompt };
    }

    // Pre-flight balance check
    var total = costPerAnky * count;

    if (!wallet) {
      status.innerHTML = '<span class="balance-low">connect your wallet first — you need USDC on Base to generate</span>';
      return;
    }

    await checkBalance();
    if (userBalance !== null && userBalance < total) {
      status.innerHTML = '<span class="balance-low">you need $' + total.toFixed(2) +
        ' USDC but you have $' + userBalance.toFixed(2) +
        '. add USDC on Base to continue.</span>';
      return;
    }

    btn.disabled = true;
    btn.textContent = 'preparing...';
    status.innerHTML = '';

    // Reset progress area
    var progressEl = document.getElementById('gen-progress');
    document.getElementById('gen-skeleton').style.display = '';
    document.getElementById('gen-result').style.display = 'none';
    document.getElementById('gen-logs').innerHTML = '';

    try {
      var headers = { 'Content-Type': 'application/json' };

      // Get treasury address first
      var treasury = await fetch('/api/treasury').then(function(r) { return r.json(); }).then(function(d) { return d.address; });

      // Pay first, then send with proof
      btn.textContent = 'approve in wallet...';
      var txHash = await window.ankyWallet.sendUSDC(treasury, total);
      btn.textContent = 'confirming...';

      // Wait for tx to propagate
      await new Promise(function(resolve) { setTimeout(resolve, 4000); });

      headers['x-payment'] = txHash;

      // Show progress area and start log stream
      progressEl.style.display = 'block';
      addLog('payment confirmed, starting generation...');
      var evtSource = startLogStream();

      var resp = await fetch('/api/v1/generate', {
        method: 'POST',
        headers: headers,
        body: JSON.stringify(payload),
      });

      if (!resp.ok) {
        var errText = await resp.text();
        evtSource.close();
        progressEl.style.display = 'none';
        status.innerHTML = '<span class="error">generation failed: ' + errText +
          '</span><br><span class="stat-dim">your tx: ' + txHash + '</span>';
        btn.disabled = false;
        btn.textContent = 'generate';
        return;
      }

      var data = await resp.json();
      addLog('anky ' + data.anky_id.slice(0, 8) + ' queued, generating image...');

      // Start polling for completion
      pollAnky(data.anky_id, evtSource);

      // For packs, queue remaining with same payment proof
      if (count > 1) {
        addLog('queuing ' + (count - 1) + ' more...');
        for (var i = 1; i < count; i++) {
          fetch('/api/v1/generate', {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(payload),
          }).catch(function() {});
          await new Promise(function(resolve) { setTimeout(resolve, 500); });
        }
        addLog('all ' + count + ' queued');
      }

      // Refresh balance
      setTimeout(checkBalance, 5000);

    } catch (e) {
      status.innerHTML = '<span class="error">' + (e.message || 'something went wrong') + '</span>';
    }

    btn.disabled = false;
    btn.textContent = 'generate';
  };

  updateCost();
})();
</script>
{% endblock %}
