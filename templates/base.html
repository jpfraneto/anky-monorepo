<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}anky{% endblock %}</title>
  <script src="/static/htmx.min.js"></script>
  <script src="/static/htmx-sse.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Righteous&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/style.css?v=20260214g">
  {% block head %}{% endblock %}
</head>
<body>
  <nav class="navbar">
    <a href="/" class="logo">anky</a>
    <button class="nav-hamburger" id="nav-hamburger" aria-label="menu">&#9776;</button>
    <div class="nav-links" id="nav-links">
      <a href="/gallery">gallery</a>
      <a href="/writings">writings</a>
      <div class="nav-dropdown">
        <a href="/generate" class="nav-dropdown-trigger">generate</a>
        <div class="nav-dropdown-menu">
          <a href="/generate">anky from prompt</a>
          <a href="/generate/video">video production</a>
        </div>
      </div>
      <a href="/prompt/create">prompts</a>
      <a href="/feedback">feedback</a>
      <a href="/changelog">changelog</a>
      <a href="/settings">settings</a>
      <a href="/help">help</a>
      <a href="/ankycoin">$ANKY</a>
    </div>
    <div class="nav-auth" id="nav-auth">
      <button class="go-live-navbar-btn" id="go-live-navbar-btn" style="display:none;">GO LIVE</button>
      <button class="wallet-btn" id="wallet-btn" onclick="window.ankyWallet.connect()">connect</button>
    </div>
  </nav>
  <div class="share-card-overlay" id="share-card-overlay">
    <button class="share-card-close" id="share-card-close">&times;</button>
    <div class="share-card">
      <div class="share-card-image">
        <img id="share-card-img" src="" alt="">
      </div>
      <h2 class="share-card-title" id="share-card-title"></h2>
      <p class="share-card-excerpt" id="share-card-excerpt"></p>
      <div class="share-card-brand">anky.app</div>
    </div>
    <div class="share-card-actions">
      <button class="share-card-btn" id="share-card-share">share</button>
      <button class="share-card-btn share-card-btn-dim" id="share-card-copy">copy link</button>
    </div>
  </div>
  {% block content %}{% endblock %}
  <script>
  // --- Wallet ---
  window.ankyWallet = (function() {
    var btn = document.getElementById('wallet-btn');
    var BASE_CHAIN = '0x2105'; // 8453
    var USDC = '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913';

    function shortAddr(a) {
      return a.slice(0, 6) + '...' + a.slice(-4);
    }

    function updateBtn() {
      var addr = localStorage.getItem('wallet_address');
      var isConnected = !!addr;
      if (addr) {
        btn.textContent = shortAddr(addr);
        btn.classList.add('connected');
        btn.onclick = disconnect;
      } else {
        btn.textContent = 'connect';
        btn.classList.remove('connected');
        btn.onclick = connect;
      }
      window.dispatchEvent(new CustomEvent('anky:wallet-changed', {
        detail: { connected: isConnected, wallet: addr || null }
      }));
    }

    function isLoggedIn() {
      return !!localStorage.getItem('wallet_address');
    }

    function connect() {
      // Navigate to the Privy login page
      window.location.href = '/login';
    }

    function disconnect() {
      localStorage.removeItem('wallet_address');
      fetch('/auth/privy/logout', { method: 'POST' }).catch(function(){});
      updateBtn();
    }

    // Send USDC on Base. Returns tx hash.
    async function sendUSDC(toAddress, amountUSD) {
      var from = localStorage.getItem('wallet_address');
      if (!from || !window.ethereum) {
        connect();
        throw new Error('wallet not connected');
      }
      // Ensure Base chain
      await window.ethereum.request({
        method: 'wallet_switchEthereumChain',
        params: [{ chainId: BASE_CHAIN }],
      });
      // ERC20 transfer(address,uint256) â€” USDC has 6 decimals
      var amount = Math.ceil(amountUSD * 1e6);
      var toHex = toAddress.slice(2).toLowerCase().padStart(64, '0');
      var amtHex = amount.toString(16).padStart(64, '0');
      var data = '0xa9059cbb' + toHex + amtHex;
      var txHash = await window.ethereum.request({
        method: 'eth_sendTransaction',
        params: [{
          from: from,
          to: USDC,
          data: data,
        }],
      });
      return txHash;
    }

    // Listen for account changes (raw ethereum)
    if (window.ethereum) {
      window.ethereum.on('accountsChanged', function(accounts) {
        if (accounts.length === 0) {
          disconnect();
        } else {
          localStorage.setItem('wallet_address', accounts[0]);
          updateBtn();
        }
      });
    }

    updateBtn();

    return { connect: connect, disconnect: disconnect, sendUSDC: sendUSDC, isLoggedIn: isLoggedIn };
  })();

  // Hamburger menu toggle
  (function() {
    var btn = document.getElementById('nav-hamburger');
    var links = document.getElementById('nav-links');
    if (btn && links) {
      btn.addEventListener('click', function() {
        links.classList.toggle('open');
      });
      links.querySelectorAll('a').forEach(function(a) {
        a.addEventListener('click', function() {
          links.classList.remove('open');
        });
      });
    }
    // Touch support for nav dropdowns
    document.querySelectorAll('.nav-dropdown-trigger').forEach(function(trigger) {
      trigger.addEventListener('click', function(e) {
        var dd = trigger.closest('.nav-dropdown');
        if (dd && window.innerWidth <= 768) return; // mobile hamburger handles it
        if (dd && !dd.classList.contains('open')) {
          e.preventDefault();
          document.querySelectorAll('.nav-dropdown.open').forEach(function(d) { d.classList.remove('open'); });
          dd.classList.add('open');
        }
      });
    });
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.nav-dropdown')) {
        document.querySelectorAll('.nav-dropdown.open').forEach(function(d) { d.classList.remove('open'); });
      }
    });
  })();

  // --- Share Card ---
  window.ankyShareCard = (function() {
    var overlay = document.getElementById('share-card-overlay');
    var closeBtn = document.getElementById('share-card-close');
    var imgEl = document.getElementById('share-card-img');
    var titleEl = document.getElementById('share-card-title');
    var excerptEl = document.getElementById('share-card-excerpt');
    var shareBtn = document.getElementById('share-card-share');
    var copyBtn = document.getElementById('share-card-copy');
    var currentAnkyId = null;

    function extractExcerpt(reflection) {
      if (!reflection) return '';
      var lines = reflection.split('\n');
      var result = '';
      for (var i = 0; i < lines.length; i++) {
        var line = lines[i].trim();
        if (!line) continue;
        // Skip greeting lines
        if (i < 3 && /^(hey|hi|hello|thanks|thank you|wow|oh)\b/i.test(line)) continue;
        // Skip markdown headings
        if (/^#{1,4}\s/.test(line)) continue;
        // Strip bold/italic markers
        line = line.replace(/\*{1,3}/g, '').replace(/_{1,3}/g, '').trim();
        if (!line) continue;
        result = line;
        break;
      }
      if (result.length > 200) {
        result = result.substring(0, 197) + '...';
      }
      return result;
    }

    function open(opts) {
      currentAnkyId = opts.ankyId || null;
      imgEl.src = opts.imageUrl || '';
      imgEl.alt = opts.title || 'anky';
      titleEl.textContent = opts.title || '';
      excerptEl.textContent = extractExcerpt(opts.reflection);
      overlay.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function close() {
      overlay.classList.remove('active');
      document.body.style.overflow = '';
    }

    closeBtn.addEventListener('click', close);

    overlay.addEventListener('click', function(e) {
      if (e.target === overlay) close();
    });

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && overlay.classList.contains('active')) close();
    });

    shareBtn.addEventListener('click', function() {
      var url = currentAnkyId ? (window.location.origin + '/anky/' + currentAnkyId) : window.location.href;
      var title = titleEl.textContent || 'my anky';
      if (navigator.share) {
        navigator.share({ title: title, text: excerptEl.textContent, url: url }).catch(function() {});
      } else {
        navigator.clipboard.writeText(url).then(function() {
          shareBtn.textContent = 'copied!';
          setTimeout(function() { shareBtn.textContent = 'share'; }, 2000);
        });
      }
    });

    copyBtn.addEventListener('click', function() {
      var url = currentAnkyId ? (window.location.origin + '/anky/' + currentAnkyId) : window.location.href;
      navigator.clipboard.writeText(url).then(function() {
        copyBtn.textContent = 'copied!';
        setTimeout(function() { copyBtn.textContent = 'copy link'; }, 2000);
      });
    });

    return { open: open, close: close, extractExcerpt: extractExcerpt };
  })();

  // Navbar arrow key navigation (roving tabindex)
  (function() {
    var navbar = document.querySelector('.navbar');
    if (!navbar) return;

    function getNavItems() {
      var items = [];
      var logo = navbar.querySelector('.logo');
      if (logo) items.push(logo);
      navbar.querySelectorAll('.nav-links a').forEach(function(a) { items.push(a); });
      var walletBtn = document.getElementById('wallet-btn');
      if (walletBtn) items.push(walletBtn);
      return items;
    }

    navbar.addEventListener('keydown', function(e) {
      var tag = e.target.tagName;
      if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

      var items = getNavItems();
      var idx = items.indexOf(e.target);
      if (idx === -1) return;

      if (e.key === 'ArrowRight' || e.key === 'ArrowLeft' || e.key === 'Tab') {
        if (e.key === 'Tab') {
          e.preventDefault();
          var next = e.shiftKey
            ? (idx - 1 + items.length) % items.length
            : (idx + 1) % items.length;
          items[next].focus();
        } else {
          e.preventDefault();
          var next = e.key === 'ArrowRight'
            ? (idx + 1) % items.length
            : (idx - 1 + items.length) % items.length;
          items[next].focus();
        }
      } else if (e.key === ' ') {
        e.preventDefault();
        e.target.click();
      } else if (e.key === 'ArrowDown') {
        e.preventDefault();
        var main = document.querySelector('main, .help-tabs, .writing-container, .gallery-grid, .container');
        if (main) {
          var focusable = main.querySelector('a, button, input, textarea, select, [tabindex]');
          if (focusable) focusable.focus();
        }
      }
    });
  })();

  // Disable browser/editor writing aids on all textareas
  (function() {
    function hardenTextarea(el) {
      if (!el || el.tagName !== 'TEXTAREA') return;
      el.setAttribute('autocomplete', 'off');
      el.setAttribute('autocorrect', 'off');
      el.setAttribute('autocapitalize', 'off');
      el.setAttribute('spellcheck', 'false');
      el.setAttribute('data-gramm', 'false');
      el.setAttribute('data-gramm_editor', 'false');
      el.setAttribute('data-enable-grammarly', 'false');
    }

    document.querySelectorAll('textarea').forEach(hardenTextarea);

    var observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(m) {
        m.addedNodes.forEach(function(node) {
          if (!node || node.nodeType !== 1) return;
          if (node.tagName === 'TEXTAREA') hardenTextarea(node);
          if (node.querySelectorAll) node.querySelectorAll('textarea').forEach(hardenTextarea);
        });
      });
    });

    observer.observe(document.documentElement, { childList: true, subtree: true });
  })();
  </script>
  {% block scripts %}{% endblock %}
</body>
</html>
