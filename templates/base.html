<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}anky{% endblock %}</title>
  <script src="/static/htmx.min.js"></script>
  <script src="/static/htmx-sse.js"></script>
  <link rel="stylesheet" href="/static/style.css?v=20260208">
  {% block head %}{% endblock %}
</head>
<body>
  <nav class="navbar">
    <a href="/" class="logo">anky</a>
    <button class="nav-hamburger" id="nav-hamburger" aria-label="menu">&#9776;</button>
    <div class="nav-links" id="nav-links">
      <a href="/gallery">gallery</a>
      <a href="/poiesis">poiesis</a>
      <a href="/writings">writings</a>
      <a href="/generate">generate</a>
      <a href="/feedback">feedback</a>
      <a href="/dashboard">dashboard</a>
      <a href="/help">help</a>
    </div>
    <div class="nav-auth" id="nav-auth">
      <button class="wallet-btn" id="wallet-btn" onclick="window.ankyWallet.connect()">connect</button>
    </div>
  </nav>
  {% block content %}{% endblock %}
  {% block scripts %}{% endblock %}
  <script>
  // --- Wallet ---
  window.ankyWallet = (function() {
    var btn = document.getElementById('wallet-btn');
    var BASE_CHAIN = '0x2105'; // 8453
    var USDC = '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913';

    function shortAddr(a) {
      return a.slice(0, 6) + '...' + a.slice(-4);
    }

    function updateBtn() {
      var addr = localStorage.getItem('wallet_address');
      if (addr) {
        btn.textContent = shortAddr(addr);
        btn.classList.add('connected');
        btn.onclick = disconnect;
      } else {
        btn.textContent = 'connect';
        btn.classList.remove('connected');
        btn.onclick = connect;
      }
    }

    async function connect() {
      if (!window.ethereum) {
        alert('install a wallet (metamask, rabby, coinbase wallet) to connect');
        return null;
      }
      try {
        var accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        var address = accounts[0];
        // Switch to Base
        try {
          await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: BASE_CHAIN }],
          });
        } catch (e) {
          if (e.code === 4902) {
            await window.ethereum.request({
              method: 'wallet_addEthereumChain',
              params: [{
                chainId: BASE_CHAIN,
                chainName: 'Base',
                nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                rpcUrls: ['https://mainnet.base.org'],
                blockExplorerUrls: ['https://basescan.org'],
              }],
            });
          }
        }
        localStorage.setItem('wallet_address', address);
        updateBtn();
        return address;
      } catch (e) {
        console.error('wallet connect failed:', e);
        return null;
      }
    }

    function disconnect() {
      localStorage.removeItem('wallet_address');
      updateBtn();
    }

    // Send USDC on Base. Returns tx hash.
    async function sendUSDC(toAddress, amountUSD) {
      var from = localStorage.getItem('wallet_address');
      if (!from || !window.ethereum) {
        var addr = await connect();
        if (!addr) throw new Error('wallet not connected');
        from = addr;
      }
      // Ensure Base chain
      await window.ethereum.request({
        method: 'wallet_switchEthereumChain',
        params: [{ chainId: BASE_CHAIN }],
      });
      // ERC20 transfer(address,uint256) â€” USDC has 6 decimals
      var amount = Math.ceil(amountUSD * 1e6);
      var toHex = toAddress.slice(2).toLowerCase().padStart(64, '0');
      var amtHex = amount.toString(16).padStart(64, '0');
      var data = '0xa9059cbb' + toHex + amtHex;
      var txHash = await window.ethereum.request({
        method: 'eth_sendTransaction',
        params: [{
          from: from,
          to: USDC,
          data: data,
        }],
      });
      return txHash;
    }

    // Listen for account changes
    if (window.ethereum) {
      window.ethereum.on('accountsChanged', function(accounts) {
        if (accounts.length === 0) {
          disconnect();
        } else {
          localStorage.setItem('wallet_address', accounts[0]);
          updateBtn();
        }
      });
    }

    updateBtn();

    return { connect: connect, disconnect: disconnect, sendUSDC: sendUSDC };
  })();

  // Hamburger menu toggle
  (function() {
    var btn = document.getElementById('nav-hamburger');
    var links = document.getElementById('nav-links');
    if (btn && links) {
      btn.addEventListener('click', function() {
        links.classList.toggle('open');
      });
      links.querySelectorAll('a').forEach(function(a) {
        a.addEventListener('click', function() {
          links.classList.remove('open');
        });
      });
    }
  })();

  // Navbar arrow key navigation (roving tabindex)
  (function() {
    var navbar = document.querySelector('.navbar');
    if (!navbar) return;

    function getNavItems() {
      var items = [];
      var logo = navbar.querySelector('.logo');
      if (logo) items.push(logo);
      navbar.querySelectorAll('.nav-links a').forEach(function(a) { items.push(a); });
      var walletBtn = document.getElementById('wallet-btn');
      if (walletBtn) items.push(walletBtn);
      return items;
    }

    navbar.addEventListener('keydown', function(e) {
      var tag = e.target.tagName;
      if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

      var items = getNavItems();
      var idx = items.indexOf(e.target);
      if (idx === -1) return;

      if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
        e.preventDefault();
        var next = e.key === 'ArrowRight'
          ? (idx + 1) % items.length
          : (idx - 1 + items.length) % items.length;
        items[next].focus();
      } else if (e.key === 'ArrowDown') {
        e.preventDefault();
        var main = document.querySelector('main, .help-page, .writing-container, .gallery-grid, .container, .poiesis-dashboard');
        if (main) {
          var focusable = main.querySelector('a, button, input, textarea, select, [tabindex]');
          if (focusable) focusable.focus();
        }
      }
    });
  })();
  </script>
</body>
</html>
