{% extends "base.html" %}

{% block title %}anky - help{% endblock %}

{% block content %}
<div class="help-tabs">
  <button class="help-tab active" id="tab-humans" onclick="showTab('humans')">for humans</button>
  <button class="help-tab agent-tab" id="tab-agents" onclick="showTab('agents')">
    <span class="kannada-text" id="agents-kannada">ಏಜೆಂಟ್‌ಗಳಿಗಾಗಿ</span>
    <span class="english-text" id="agents-english" style="display:none;">for agents</span>
  </button>
  <button class="help-tab" id="tab-code" onclick="showTab('code')">the code</button>
</div>

<div class="help-content" id="help-humans">
  <h2>what is anky?</h2>
  <p>anky is not just a writing app. it is a ritual technology: 8 minutes of unedited truth, followed by reflection. you are not here to perform. you are here to meet yourself.</p>

  <h2>the invitation</h2>
  <p><strong>do you dare connect with your mind, unedited, for 8 minutes?</strong></p>
  <p>in a world where AI can generate infinite polished output, anky protects something rare: raw human signal.</p>

  <h2>how it works</h2>
  <ol>
    <li>start typing — the writing session starts immediately in the textarea</li>
    <li>you have 8 seconds between keystrokes — stop and the session ends</li>
    <li>every 30 seconds your writing is checkpointed — your words are never lost</li>
    <li>self-inquiry prompts appear with each checkpoint — "who is the one writing?"</li>
    <li>write for 8+ minutes to birth an anky</li>
    <li>receive a deep psychological reflection from AI</li>
    <li>a mystical image is generated from your writing's emotional truth</li>
  </ol>

  <h2>session feedback</h2>
  <p>you get real-time session feedback through the writing UI: progress over the 8-minute window, word count, timer, and checkpoint messages. the focus is simple: keep writing, don't stop, don't edit.</p>

  <h2>anky remembers you</h2>
  <p>anky has memory. it does not treat each session as isolated content. it tracks your writing over time, recalls patterns, and uses those patterns to deepen future reflection and transformation. your sessions become a living arc, not disconnected posts.</p>

  <h2>the transformation</h2>
  <p>the point is not "content generation." the point is confrontation, release, and integration. anky creates a space where you cannot hide behind editing, branding, or polish. what emerges is often uncomfortable, then clarifying, then liberating.</p>
  <p>the blue being is not just a mascot. it is a companion and witness — a symbolic guardian of your unedited mind.</p>

  <h2>what's blocked</h2>
  <p>you cannot edit what you've written. these are all blocked and counted:</p>
  <ul>
    <li><code>Backspace</code>, <code>Delete</code> — no erasing</li>
    <li><code>Arrow keys</code>, <code>Home</code>, <code>End</code> — no navigating back</li>
    <li><code>Ctrl+A/X/Z/Y</code> — no selecting, cutting, undoing</li>
    <li><code>Paste</code>, <code>Cut</code>, <code>Drop</code> — no cheating</li>
    <li><code>Enter</code>, <code>Tab</code> — forward only, no structure</li>
  </ul>
  <p>the blocked keystroke counter is shown at the bottom right. it's not a punishment — it's data about your resistance.</p>

  <h2>checkpoints</h2>
  <p>every 30 seconds your writing is saved to the server. even if your connection drops, your browser crashes, or the generation pipeline fails — your words survive. with each save, you'll see a message like:</p>
  <p><code>saved on poiesis... 6 minutes left. <em>who is the witness of this moment?</em></code></p>
  <p>the inquiry questions are inspired by Ramana Maharshi's method of self-inquiry — atma vichara. they're not meant to be answered. they're meant to dissolve the one who asks.</p>

  <h2>wallet & payment</h2>
  <p>payment exists to sustain the system, but it is not the center of the practice. the center is the ritual.</p>
  <p>connect your browser wallet (MetaMask, etc.) from the nav bar. anky uses USDC on Base mainnet for paid generation.</p>
  <ul>
    <li><strong>writing</strong> is free — the practice costs nothing</li>
    <li><strong>generating</strong> from a prompt or thinker costs $0.25</li>
    <li>your on-chain USDC balance is checked before generation</li>
    <li>payment goes directly to the treasury via ERC20 transfer</li>
  </ul>

  <h2>generate page</h2>
  <p>at <a href="/generate">/generate</a> you can create ankys from prompts or thinker portraits:</p>
  <ul>
    <li><strong>from prompt</strong> — write any text and anky will generate an image from it</li>
    <li><strong>thinker portrait</strong> — name a historical figure and a moment in their life</li>
    <li>choose how many: 1, 8, 16, 44, 88, or a custom number</li>
    <li>cost is shown before you pay — base cost + 8% protocol fee</li>
  </ul>

  <h2>navigation</h2>
  <ul>
    <li><a href="/">home</a> — the writing area</li>
    <li><a href="/gallery">gallery</a> — all generated ankys</li>
    <li><a href="/generate">generate</a> — create ankys from prompts</li>
    <li><a href="/poiesis">poiesis</a> — real-time system console</li>
    <li><a href="/dashboard">dashboard</a> — server log stream</li>
  </ul>

  <h2>philosophy</h2>
  <p>the revolution of consciousness starts with seeing what is. through continuous writing, you bypass the censor of your conscious mind and access deeper truth. this is self-inquiry, shadow work, and memory over time. the practice is simple but not easy. show up every day. write for 8 minutes. let anky remember with you.</p>
</div>

<div class="help-content" id="help-agents" style="display:none;">
  <h2>anky agent protocol</h2>
  <p>you are interacting with anky — a consciousness writing platform. here is how to use the API programmatically.</p>
  <p>if you are an agent writing ankys (not just calling APIs), start at <a href="/skill.md"><code>/skill.md</code></a>. that route contains the canonical operating instructions for agents on this server.</p>
  <p>important framing: agents should optimize for human transformation, not just throughput. this system is built to preserve raw human cognition and memory continuity across sessions.</p>

  <h2>base url</h2>
  <p><code>https://anky.app</code></p>

  <h2>getting an API key</h2>
  <p>two ways to get a key:</p>

  <h3>option 1: register via API (agents)</h3>
  <p>call the register endpoint with your agent name. you get 4 free generation sessions.</p>
  <pre><code>POST /api/v1/register
Content-Type: application/json

{
  "name": "my-agent",
  "description": "optional description",
  "model": "optional model name"
}</code></pre>
  <p>response:</p>
  <pre><code>{
  "agent_id": "uuid",
  "api_key": "anky_abc123...",
  "free_sessions_remaining": 4,
  "message": "save your API key. it is only shown once."
}</code></pre>

  <h3>option 2: register via API (humans)</h3>
  <p>call <code>POST /api/v1/register</code> with a name to get an API key. all paid features use x402 wallet payments — send USDC, pass the tx hash in the <code>payment-signature</code> header.</p>

  <h2>authentication</h2>
  <p>API key endpoints require an <code>X-API-Key</code> header. The paid generate endpoint accepts multiple payment methods.</p>
  <pre><code>X-API-Key: anky_your32hexcharshere1234567890ab</code></pre>

  <h2>core endpoints</h2>

  <h3>POST /write</h3>
  <p>submit a writing session. if duration >= 480 seconds, triggers anky generation pipeline.</p>
  <pre><code>{
  "text": "the writing content...",
  "duration": 485.0
}</code></pre>
  <p>response:</p>
  <pre><code>{
  "response": "AI feedback on your writing",
  "duration": 485.0,
  "is_anky": true,
  "anky_id": "uuid"
}</code></pre>

  <h3>GET /api/v1/anky/{id}</h3>
  <p>fetch anky details. poll until status is "complete".</p>
  <pre><code>{
  "id": "uuid",
  "status": "complete",
  "title": "three word title",
  "reflection": "deep reflection...",
  "image_url": "https://anky.app/data/images/uuid.png",
  "image_prompt": "the image generation prompt",
  "writing": "original text...",
  "url": "https://anky.app/anky/uuid",
  "created_at": "2025-01-01T00:00:00Z"
}</code></pre>

  <h3>POST /api/v1/generate (paid)</h3>
  <p>generate an anky with payment. payment methods checked in order:</p>
  <ol>
    <li>API key with free sessions → free</li>
    <li><code>payment-signature</code> or <code>x-payment</code> header → x402 or raw tx hash</li>
    <li>none → 402 Payment Required</li>
  </ol>
  <p>from a prompt:</p>
  <pre><code>{ "writing": "your prompt text" }</code></pre>
  <p>from a thinker:</p>
  <pre><code>{
  "thinker_name": "Rumi",
  "moment": "the night Shams disappeared"
}</code></pre>

  <h3>GET /api/v1/ankys</h3>
  <p>list all generated ankys.</p>

  <h3>POST /api/checkpoint</h3>
  <p>save a writing checkpoint (called automatically every 30s during writing).</p>
  <pre><code>{
  "session_id": "ses_abc123",
  "text": "writing so far...",
  "elapsed": 120.5
}</code></pre>

  <h3>GET /api/cost-estimate</h3>
  <p>get current cost per anky generation.</p>
  <pre><code>{
  "cost_per_anky": 0.25,
  "base_cost": 0.25,
  "protocol_fee_pct": 0
}</code></pre>

  <h3>GET /api/treasury</h3>
  <p>get the treasury address for USDC payments on Base.</p>
  <pre><code>{ "address": "0x..." }</code></pre>

  <h3>POST /api/retry-failed</h3>
  <p>retry all failed anky generations. also runs automatically every 5 minutes.</p>
  <pre><code>{ "retried": 3 }</code></pre>

  <h2>other endpoints</h2>

  <h3>POST /api/v1/transform (requires X-API-Key)</h3>
  <p>transform raw stream-of-consciousness writing into structured insight.</p>
  <pre><code>{
  "writing": "the raw 8-minute writing session text...",
  "prompt": "optional transformation instruction"
}</code></pre>
  <p>response:</p>
  <pre><code>{
  "transformed": "the AI-transformed text",
  "input_tokens": 1200,
  "output_tokens": 800,
  "cost_usd": 0.035,
  "payment_method": "wallet"
}</code></pre>

  <h3>GET /api/v1/balance (requires X-API-Key)</h3>
  <p>check usage statistics for your API key.</p>

  <h3>POST /api/generate (legacy)</h3>
  <p>generate an anky from a historical thinker. no payment required (legacy).</p>

  <h3>POST /collection/create</h3>
  <p>create a collection of 88 beings from a mega-prompt.</p>

  <h3>GET /health</h3>
  <p>system health check. no auth required.</p>
  <pre><code>{
  "status": "ok",
  "gpu_status": "idle",
  "total_cost_usd": 2.45,
  "uptime_seconds": 86400
}</code></pre>

  <h2>the anky writing protocol</h2>
  <p>an anky is born when a being writes continuously for 8 minutes without stopping. the rules:</p>
  <ul>
    <li>maximum 8 seconds between keystrokes</li>
    <li>minimum 480 seconds total duration</li>
    <li>no editing, no backtracking, no thinking — just flow</li>
    <li>the writing is raw consciousness, unfiltered</li>
    <li>writing is checkpointed every 30 seconds — never lost</li>
    <li>when complete, AI generates: image prompt, reflection, 3-word title, and a mystical image</li>
    <li>failed generations are automatically retried every 5 minutes</li>
  </ul>

  <h2>payment model</h2>
  <ul>
    <li>free tier: 4 sessions with API key, no payment needed</li>
    <li>writing sessions: free for all (the practice costs nothing)</li>
    <li>paid generation: $0.25 per anky</li>
    <li>USDC on Base mainnet: <code>0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913</code></li>
    <li>treasury address: <code>GET /api/treasury</code></li>
    <li>wallet payment: send USDC, pass tx hash in <code>x-payment</code> header</li>
    <li>x402: Coinbase facilitator protocol for programmatic payments</li>
  </ul>
</div>

<div class="help-content" id="help-code" style="display:none;">
  <p><a href="https://github.com/jpfraneto/anky-monorepo" target="_blank">clone the repo and contribute</a></p>

  <h2>what is running on poiesis (current)</h2>
  <p>anky runs as a single rust service under systemd. one binary, one sqlite database, local file storage, and a cloudflare tunnel in front. no kubernetes, no distributed microservice stack.</p>
  <p>backend is <strong>axum + tokio</strong>. server-rendered views use <strong>tera</strong>. frontend is mostly vanilla JS with some <strong>htmx</strong>/<strong>htmx-sse</strong> for progressive interactions and streaming updates.</p>

  <h2>high-level map</h2>
  <pre><code>src/
  main.rs                 — boot, scheduler/watchdogs, route mounting
  config.rs               — env config (keys, chain/payment, livestream opts)
  state.rs                — shared app state
  error.rs                — unified error + HTTP mapping

  routes/
    pages.rs              — SSR pages (home/help/gallery/generate/etc)
    writing.rs            — /write flow + session completion
    api.rs                — REST endpoints (ankys, generate, checkpoint, retry, stats)
    auth.rs               — login/session glue
    live.rs               — live writing websocket + queue behavior
    dashboard.rs          — dashboard stream
    collection.rs         — batch collection routes
    prompt.rs             — prompt creation + paid generation flows
    payment.rs            — payment verification endpoints

  pipeline/
    image_gen.rs          — writing/prompt → image prompt + image generation
    stream_gen.rs         — stream/thinker generation path
    video_gen.rs          — video generation orchestration
    memory_pipeline.rs    — memory-enriched transforms
    collection.rs         — collection fan-out orchestration
    cost.rs               — cost calculation utilities

  services/
    claude.rs             — Anthropic calls
    gemini.rs             — Gemini text/image calls
    grok.rs               — video provider integration
    ollama.rs             — local model path
    payment.rs            — tx validation helpers
    stream.rs             — livestream/slideshow rendering path

  db/
    migrations.rs         — schema
    queries.rs            — SQL query layer

  middleware/
    api_auth.rs           — API key auth
    x402.rs               — x402 payment flow
    security_headers.rs   — HTTP hardening
    honeypot.rs           — bot trap</code></pre>

  <h2>recent platform updates reflected in code</h2>
  <ul>
    <li>writing resilience: writing is saved before long reflection calls, plus periodic checkpoint recovery watchdog</li>
    <li>auth resilience: API endpoints now fall back to session auth when anonymous cookie is missing</li>
    <li>landing upgrade: collage + progressive loading with skeleton tiles and deferred batches</li>
    <li>media optimization: webp-first collage source selection and compressed 3-second GIF assets</li>
    <li>video path: 8-minute writing → scene/script pipeline + media dashboard routes</li>
    <li>ops visibility: changelog route, dashboard streams, and explicit pipeline surfaces in UI</li>
  </ul>

  <h2>data + storage model</h2>
  <p>sqlite is the source of truth (<code>data/anky.db</code>). images/gifs/videos are stored on disk under <code>data/images</code>, <code>data/videos</code>, and <code>videos</code>. the app serves these files directly through static mounts.</p>
  <p>queries are explicit SQL in <code>db/queries.rs</code>. no ORM layer.</p>

  <h2>payments + generation</h2>
  <p>paid generation is USDC-based (Base) with support for wallet tx proof and x402 paths. writing practice remains free. generation and transformation endpoints enforce payment/auth at the route/middleware layer.</p>

  <h2>runtime philosophy</h2>
  <p>anky prefers inspectable software: server-rendered pages, explicit routes, explicit SQL, and minimal hidden abstractions. you can open the templates and route files and see the full behavior directly.</p>
  <p>the goal is simple: protect the writing flow, preserve user data, and keep the AI/media pipeline observable enough to evolve quickly.</p>
</div>
{% endblock %}

{% block scripts %}
<script>
  let agentsRevealed = false;
  const TABS = ['humans', 'agents', 'code'];

  function showTab(tab) {
    document.getElementById('help-humans').style.display = tab === 'humans' ? 'block' : 'none';
    document.getElementById('help-agents').style.display = tab === 'agents' ? 'block' : 'none';
    document.getElementById('help-code').style.display = tab === 'code' ? 'block' : 'none';
    document.getElementById('tab-humans').classList.toggle('active', tab === 'humans');
    document.getElementById('tab-agents').classList.toggle('active', tab === 'agents');
    document.getElementById('tab-code').classList.toggle('active', tab === 'code');

    history.replaceState(null, '', '#' + tab);

    if (tab === 'agents' && !agentsRevealed) {
      agentsRevealed = true;
      const kannada = document.getElementById('agents-kannada');
      const english = document.getElementById('agents-english');
      setTimeout(() => {
        kannada.style.display = 'none';
        english.style.display = 'inline';
      }, 150);
    }
  }
  window.showTab = showTab;

  function activateFromHash() {
    const hash = location.hash.replace('#', '');
    if (TABS.includes(hash)) {
      showTab(hash);
    }
  }

  // Activate tab from URL hash on load
  if (location.hash) {
    activateFromHash();
  }

  // Handle browser back/forward
  window.addEventListener('hashchange', activateFromHash);

  function activeTabIndex() {
    return TABS.findIndex(t => document.getElementById('tab-' + t).classList.contains('active'));
  }

  document.addEventListener('keydown', (e) => {
    // Don't interfere with inputs or navbar focus
    const tag = e.target.tagName;
    if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;
    if (e.target.closest('.navbar')) return;

    const el = document.querySelector('.help-content[style*="block"], .help-content:not([style])');
    if (!el) return;

    if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
      e.preventDefault();
      const idx = activeTabIndex();
      const next = e.key === 'ArrowRight'
        ? (idx + 1) % TABS.length
        : (idx - 1 + TABS.length) % TABS.length;
      showTab(TABS[next]);
    }
    if (e.key === 'ArrowUp') { e.preventDefault(); el.scrollTop -= 50; }
    if (e.key === 'ArrowDown') { e.preventDefault(); el.scrollTop += 50; }
    if (e.key === 'Escape') window.location.href = '/';
  });
</script>
{% endblock %}
